
<link rel="import" href="../../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../../bower_components/juicy-ace-editor/juicy-ace-editor.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>


<link rel='import' href ="./aq-editor-toolbar.html">
<link rel='import' href ="./aq-editor-console-window.html">
<link rel='import' href ="./aq-editor-sidebar-run.html">
<link rel='import' href ='./aq-editor-edit-nonprogrammer.html'>
<link rel='import' href ='./aq-editor-edit-programmer.html'>

<dom-module id="aq-editor-edit">

<style>

  paper-icon-button {
    width:35px;
    height:35px;
  }

  #consoleWindow {
    position: absolute;
    bottom:1%;
    height:89%;
    width:97%; 
    left:0px;
    --border:1px solid;
    left:2%;
    --min-width: 5%;
    background-color: white;
  }

  paper-toolbar {
      --paper-toolbar-height:40px;
    }

</style>

<style is="custom-style" include="iron-flex iron-positioning"></style>

<template>
    <iron-ajax
          auto  
          url="http://localhost:3002/api/v2/strategy/[[strategyId]]"
          method='GET'
          id='getStrategyQuery'
          handle-as="json"
          on-response="onGetStrategy"
          headers='{{header}}'
          debounce-duration="300">
    </iron-ajax>  

    <template is='dom-if' if="{{strategy}}">         
        <paper-header-panel class="fit" mode="seamed"> 
          <aq-editor-toolbar is-programmer={{isProgrammer}} class="paper-header" strategy-name="[[strategy.name]]"" strategy-desc="[[strategy.description]]"></aq-editor-toolbar>
          
          <template is='dom-if' if='{{isProgrammer}}'>
            <aq-editor-edit-programmer code="[[strategy.code]]" id='codeEditorPanel'></aq-editor-edit-programmer> 
          </template>
           
          <template is='dom-if' if='{{!isProgrammer}}'>
            <aq-editor-edit-nonprogrammer strategy={{strategy}} id='editorPanel'></aq-editor-edit-nonprogrammer> 
          </template>
               
          <iron-collapse id='collapse'>
            <aq-editor-console-window id="consoleWindow" class="collapse-content"></aq-editor-console-window>
          </iron-collapse>
        </paper-header-panel>
                      
      </template>

      <iron-ajax 
        url="http://localhost:3002/api/v2/strategy/[[strategyId]]" 
        body="{{putStrategyData}}" 
        method='PUT' 
        id='saveStrategyQuery' 
        headers='{{header}}' 
        handle-as="json" 
        on-response="onStrategySaved" 
        last-response="{{ajaxResponse}}" 
        debounce-duration="300">
    </iron-ajax>

    <iron-ajax 
        url="http://localhost:3002/api/v2/strategy/[[strategyId]]/exec" 
        body="{{runStrategyData}}" 
        method='POST' 
        id='runStrategyQuery' 
        headers='{{header}}' 
        handle-as="json" 
        on-response="onStrategyExecution" 
        last-response="{{ajaxResponse}}" 
        debounce-duration="300">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is:'aq-editor-edit',

      properties :{
        isProgrammer:{
          type:Boolean,
          value:true,
        },

        strategyId: String,
        
        runSwitch:{
          type: Number,
          value:0,
        },
      },

      attached() {
        this.fire('close-menu');
      },

      listeners: {
        'close-all':'closeAll',
        'toggle-drawer':'toggleDrawer',
        'toggle-console':'toggleConsole',
        'close-console':'closeConsole',
        'selected-items-changed':'rowSelected',
        'toggle-design':'designChanged',
        'back-clicked':'goToHome',
        //'analyze-clicked':'goToAnalyze',
        'open-drawer':'openDrawer',
        'close-drawer':'closeDrawer',
        'save-action':'saveStrategy',
        'run-action':'runStrategy',
      },

      ready: function() {
          var x = localStorage.getItem('my-app-storage');
          var user = JSON.parse(x).user;
          this.header = {
              "aimsquant-token": user.token,
              "Content-Type": "application/json"
          };
      },

      toggleConsole() {
        this.$.collapse.toggle();
      },

      openConsole() {
        if (this.$.collapse.opened == false) {
          this.$.collapse.toggle();
        }
      },

      closeConsole() {
       if (this.$.collapse.opened == true) {
          this.$.collapse.toggle();
        }
      },

      closeAll() {
        this.$$('#codeEditorPanel').closeDrawer();
        this.closeConsole();
      },

      toggleDrawer() {
        this.$$('#codeEditorPanel').toggleDrawer();
      },

      openDrawer() {
        this.$$('#codeEditorPanel').openDrawer();
      },

      closeDrawer() {
        this.$$('#codeEditorPanel').closeDrawer();
      },

      designChanged() {
        this.isProgrammer = !this.isProgrammer;
      },

      goToHome() {
        this.router.go('/dashboard/editor');
      },

      goToAnalyze() {
        this.router.go('/dashboard/analyze?strategyName=Sample Strategy');
      },

      onGetStrategy(data) {
        this.strategy = data.detail.response;
      },

      onStrategySaved(data) {
        this.strategy = data.detail.response;

        if(this.runSwitch == 1) {
          //reset the run swtch to off
          this.runSwitch = 0;

          //now run the saved strategy
          this.$.runStrategyQuery.generateRequest();
        }
      },

      saveStrategy(e) {
        this.putStrategyData = {
            "name":e.detail.name,
            "description": this.strategy.description,
            "language":this.strategy.language,
            "type": this.strategy.type,
            "code": this.$$('#codeEditorPanel').getCodeContent(),
        };
      
        this.$.saveStrategyQuery.generateRequest();
      },

      runStrategy(e) {
        console.log("I caught the run Event");
        // first save the strategy
        this.runStrategyData = {  
                  "start": "2015-11-07T03:41:47.262Z",
                  "end": "2016-11-07T03:41:47.262Z",
                  "capital": 1000000,
                  "plan": "string"};

        this.runSwitch = 1;
        this.saveStrategy(e);
        
      },

      onStrategyExecution(data) {
        console.log(data);
        //This get back the created backtest object with just the settings,
        //HAS no output
      },

    });
  </script>

</dom-module>  
