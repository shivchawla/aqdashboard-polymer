<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>
<link rel='import' href='../../../bower_components/app-route/app-route.html'>
<link rel='import' href='../../../bower_components/app-route/app-location.html'>
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel='import' href="../common/aq-check-authentication.html">
<link rel='import' href="./aq-editor-toolbar.html">
<link rel='import' href="./aq-editor-console-window.html">
<link rel='import' href="./aq-editor-sidebar-run.html">
<link rel='import' href="./aq-editor-sidebar-log.html">
<link rel='import' href="./aq-vertical-icon-selector.html">
<!--link rel='import' href ='./aq-editor-edit-nonprogrammer.html'-->
<link rel='import' href='./aq-editor-edit-programmer.html'>
<link rel='import' href='./aq-editor-edit-backtest-screen.html'>
<link rel='import' href='../../icons/aq-iconset.html'>

<dom-module id="aq-editor-edit">

    <style include="iron-flex iron-flex-alignment iron-positioning">
    </style>

    <style>

        paper-icon-button {
            width: 35px;
            height: 35px;
        }

        #consoleWindow {
            position: absolute;
            bottom: 1%;
            height: 89%;
            width: 97%;
            left: 0px;
            --border: 1px solid;
            left: 2%;
            --min-width: 5%;
            background-color: white;
        }

        paper-toolbar {
            --paper-toolbar-height: 40px;
            --paper-toolbar-color: #24293d;
            --paper-toolbar-background: #cbefde;
            -- #9ecbda;
            -- #c9e2ea;
            border-bottom: 1px solid #24293d;
        }

        paper-tabs :hover {
            font-weight: bold;
            font-size: 110%;
        }

        paper-tabs {
            --paper-tabs-selection-bar-color: #24293d;
            height: 80%;
        }

        paper-tab {
            --height: 30px;
        }

        .toolbarPlayIcon {
            border: 1px solid;
            padding: 0px;
            height: 23px;
            width: 23px;
        }

        #sidebar {
            height: 100%;
            padding-top: 5px;
            padding-bottom: 5px;
            padding-right: 5px;
        }

        #sidebarLeft {
            border-right: 1px solid;
            width: 90%;
        }

        #verticalSelector {
            width: 10%;
            height: 100%;
        }

        #rightPanel {
          background-color: #E5E5E5;
        }
        
    </style>

    <style include="iron-flex iron-positioning"></style>

    <template>

        <aq-check-authentication id='authItem'></aq-check-authentication>

        <iron-ajax
                url="[[computeGetStrategyUrl(strategyId)]]"
                method='GET'
                id='getStrategyQuery'
                handle-as="json"
                on-response="onGetStrategyResponse"
                on-error="onGetStrategyError"
                headers='{{header}}'
                debounce-duration="300"
                loading='{{loading}}'>
        </iron-ajax>

        <iron-ajax
                url="[[computePutStrategyUrl(strategyId)]]"
                body="{{putStrategyData}}"
                method='PUT'
                id='saveStrategyQuery'
                headers='{{header}}'
                handle-as="json"
                on-response="onStrategySavedResponse"
                on-error="onStrategySavedResponseError"
                last-response="{{ajaxResponse}}"
                debounce-duration="300">
        </iron-ajax>

        <iron-ajax
                url="[[computePostStrategyExecutionUrl(strategyId)]]"
                body="{{runStrategyData}}"
                method='POST'
                id='runStrategyQuery'
                headers='{{header}}'
                handle-as="json"
                on-response="onStrategyExecutionResponse"
                on-error="onStrategyExecutionError"
                last-response="{{ajaxResponse}}"
                debounce-duration="300">
        </iron-ajax>

        <aq-loading-progress loading='{{loading}}'></aq-loading-progress>

        <template is='dom-if' if='{{isLoadedWithStrategy(loading, strategy)}}'>
            <div id='container' class="fit">

                <paper-header-panel id='leftPanel' mode="seamed">

                    <template is='dom-if' if='[[!isRunning]]'>
                        <aq-editor-toolbar id='editorToolbar' is-programmer={{isProgrammer}} class="paper-header"
                                           strategy-name="[[strategy.name]]" strategy-desc="[[strategy.description]]"
                                           narrow="[[narrow]]" strategy-id="[[strategyId]]">
                        </aq-editor-toolbar>
                    </template>

                    <template is='dom-if' if='[[isRunning]]'>
                        <aq-editor-edit-backtest-screen is-running="{{isRunning}}"
                                                        id='backtestScreen'
                                                        narrow="[[narrow]]"
                                                        backtest-id="[[activeBacktestId]]">
                        </aq-editor-edit-backtest-screen>
                    </template>

                    <paper-drawer-panel
                            id="drawerpanel"
                            drawer-width="[[computeDrawerWidth(isProgrammer, isRunning)]]"
                            right-drawer
                            responsive-width='840px'
                            narrow="{{narrow}}"
                            force-narrow="{{!showSideBar}}">

                        <template is='dom-if' if='[[showProgrammerWindow(isRunning, isProgrammer)]]'>
                            <aq-editor-edit-programmer main code="[[strategy.code]]"
                                                       id='codeEditorPanel'></aq-editor-edit-programmer>
                        </template>


                        <paper-header-panel id='rightPanel' drawer mode="seamed">

                            <div id="sidebar" class="layout horizontal">
                                <iron-pages id="sidebarLeft" selected="{{selectedSidebar}}">

                                    <aq-editor-sidebar-run id='runSidebar'></aq-editor-sidebar-run>

                                    <aq-editor-sidebar-log id='logContainer'></aq-editor-sidebar-log>

                                </iron-pages>

                                <aq-vertical-icon-selector id="verticalSelector"
                                                           selected="{{selectedSidebar}}"
                                                           icons-array="[[iconsArray]]">
                                </aq-vertical-icon-selector>

                            </div>

                        </paper-header-panel> <!--inner header panel for MAIN Toolbar-->

                    </paper-drawer-panel> <!--inner drawer panel-->

                </paper-header-panel>
            </div>

            <!--/paper-drawer-panel-->
        </template>

    </template>

    <script>
        Polymer({
            is: 'aq-editor-edit',

            properties: {
                showSideBar: {
                    type: Boolean,
                    value: true,
                },

                narrow: {
                    type: Boolean,
                    observer: '_narrowChanged',
                },

                selectedSidebar: {
                    type: Number,
                    value: 0,
                    observer: "_isSelectedSidebarChanged",
                },

                sideBarOpen: {
                    type: Boolean,
                    value: true,
                },

                isProgrammer: {
                    type: Boolean,
                    value: true,
                },

                strategyId: {
                    type: String,
                    observer: '_strategyIdChanged',
                },

                strategy: Object,

                runSwitch: {
                    type: Number,
                    value: 0,
                },

                isRunning: {
                    type: Boolean,
                    value: false,
                },

                putStrategyData: Object,

                runStrategyData: Object,

                activeBacktestId: String,

                loading: Boolean,

                iconsArray: {
                    type: Array,
                    value: ["aq-icons:settings", "aq-icons:graphic-eq"],
                },

            },

            listeners: {
                'close-all': 'closeAll',
                'toggle-drawer': 'toggleDrawer',
                'toggle-console': 'toggleConsole',
                'close-console': 'closeConsole',
                'selected-items-changed': 'rowSelected',
                'toggle-design': 'designChanged',
                'backClicked': 'goToHome',
                //'analyze-clicked':'goToAnalyze',
                'open-drawer': 'openDrawer',
                'close-drawer': 'closeDrawer',
                'save-action': 'saveStrategy',
                'run-action': 'runStrategy',
                'cloneClicked': 'cloneStrategy',
                'backClicked-backtest': 'toggleIsRunning',
                'scroll-log': 'onScroll',
                'save-request': 'onSaveRequest',
            },

            attached: function () {

                if (!this.$.authItem.checkHasToken()) {
                    this.fire('rt-changed', {route: '/user/signin'});
                    return;
                } else {
                    this.header = this.$.authItem.getHeader();
                    this.$.getStrategyQuery.generateRequest();
                    this.fire('close-menu');
                    this.selectedSidebar = 0;
                }
                
                this.isRunning = false;
            },

            computeGetStrategyUrl: function (strategyId) {
                var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                return APIEndPoint + '/strategy/' + strategyId;
            },

            computePutStrategyUrl: function (strategyId) {
                var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                return APIEndPoint + '/strategy/' + strategyId;
            },

            computePostStrategyExecutionUrl: function (strategyId) {
                var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                return APIEndPoint + '/strategy/' + strategyId + '/exec';
            },

            _narrowChanged: function (newVal, oldVal) {
                if (!newVal && !this.isRunning && this.$$('#codeEditorPanel')) {
                    this.$$('#codeEditorPanel').style.display = 'block';
                }
            },

            computeDrawerWidth: function (isProgrammer, isRunning) {
                if (isProgrammer && isRunning) {
                    return "440px";
                } else if (isProgrammer) {
                    return "440px";
                } else {
                    return "0px";
                }
            },

            toggleConsole: function () {
                this.$.collapse.toggle();
            },

            openConsole: function () {
                if (this.$.collapse.opened == false) {
                    this.$.collapse.toggle();
                }
            },

            closeConsole: function () {
                if (this.$.collapse.opened == true) {
                    this.$.collapse.toggle();
                }
            },

            closeAll: function () {
                this.$$('#codeEditorPanel').closeDrawer();
                this.closeConsole();
            },

            toggleDrawer: function () {
                if (this.showSideBar && this.narrow) {
                    this.$$('#drawerpanel').togglePanel();

                    var x = this.$$('#codeEditorPanel').style.display;

                    if (x == 'none' && !this.isRunning) {
                        this.$$('#codeEditorPanel').style.display = 'block';
                    } else {
                        this.$$('#codeEditorPanel').style.display = 'none';
                    }

                } else if (this.showSideBar && !this.narrow) {
                    this.closeDrawer();
                } else {
                    this.openDrawer();
                }

            },

            openDrawer: function () {
                this.$$('#drawerpanel').openDrawer();
                this.showSideBar = true;
            },

            closeDrawer: function () {
                this.$$('#drawerpanel').closeDrawer();

                if (this.showSideBar && !this.narrow) {
                    this.showSideBar = false;
                }
            },

            isSelectedSidebarRun: function (selectedSidebar) {
                return selectedSidebar == 0;
            },

            designChanged: function () {
                this.isProgrammer = !this.isProgrammer;
            },

            goToAnalyze: function () {
                this.fire('rt-changed', {route: '/dashboard/analyze?strategyName=Sample Strategy'});
            },

            goToHome: function () {
                this.fire('rt-changed', {route: '/dashboard/editor'});
            },

            onGetStrategyResponse: function (data) {
                this.strategy = data.detail.response;
            },

            onGetStrategyError: function (data) {
            },

            onStrategySavedResponse: function (data) {
                // Check if save was initiated before RUN
                if (this.runSwitch == 1) {

                    //reset the run switch to off
                    this.runSwitch = 0;

                    // Now run the saved strategy
                    if (this.$.authItem.checkHasToken()) {
                        this.header = this.$.authItem.getHeader();
                        this.$.runStrategyQuery.generateRequest();
                    }
                }

            },

            onStrategySavedError: function (data) {
            },

            runStrategyFromPanel: function () {
                this.$$('#editorToolbar').onRun();
            },

            saveStrategy: function (e) {

                this.putStrategyData = {
                    "name": e.detail.name,
                    "description": this.strategy.description,
                    "language": this.strategy.language,
                    "type": this.strategy.type,
                    "code": this.$$('#codeEditorPanel').getCodeContent(),
                };

                if (this.$.authItem.checkHasToken() && this.strategyId != "") {
                    this.header = this.$.authItem.getHeader();
                    this.$.saveStrategyQuery.generateRequest();
                }
            },

            runStrategy: function (e) {

                // first save the strategy
                this.runStrategyData = this.$$('#runSidebar').getSettings();

                this.runSwitch = 1;
                this.saveStrategy(e);

                //Reset log container
                if (this.$$('#logContainer')) {
                    this.$$('#logContainer').resetLogs();
                }

            },

            onStrategyExecutionResponse: function (data) {

                //Before execution starts,
                //backtestId handle is sent from the backend
                this.activeBacktestId = data.detail.response._id;
                //This backtest object just contains settings and code
                //BUT has no output

                // Send Execution request via web-sockets
                this.isRunning = true;
                this.selectedSidebar = 1;

                this.fire('execute-backtest', {backtestId: this.activeBacktestId});

                this.fire('iron-signal', {name: 'backtest-added'});


            },

            onStrategyExecutionError: function (data) {
                console.log(data.detail);
                //This get back the created backtest object with just the settings,
                //HAS no output
            },

            cloneStrategy: function (e) {
                e.detail.strategy = this.strategy;
                //let the event propagate
            },

            _isSelectedSidebarChanged: function (nSelect, oSelect) {
                if (nSelect == 0 && this.$$('#rightPanel')) {
                    this.$$('#rightPanel').style.backgroundColor = 'white';
                } else if (this.$$('#rightPanel')) {
                    this.$$('#rightPanel').style.backgroundColor = 'black';
                }
            },

            onScroll: function () {
                this.$$('#rightPanel').scroller.scrollTop += this.$$('#rightPanel').scroller.scrollHeight;
            },

            showProgrammerWindow: function (isRunning, isProgrammer) {
                return !isRunning && isProgrammer;
            },

            _strategyIdChanged: function (nId, oId) {

                if (nId && this.$.authItem.checkHasToken()) {
                    this.header = this.$.authItem.getHeader();
                    this.$.getStrategyQuery.generateRequest();

                    this.fire('close-menu');
                    this.selectedSidebar = 0;
                }
            },

            checkForKeys: function (event) {
                if (event.ctrlKey || event.metaKey) {
                    switch (String.fromCharCode(event.which).toLowerCase()) {
                        case 's':
                            event.preventDefault();
                            this.$$('#editorToolbar').onSave();
                            break;
                    }
                }

            },

            onSaveRequest: function () {
                if (this.$$('#editorToolbar')) {
                    this.$$('#editorToolbar').onSave();
                }
            },

            isLoadedWithStrategy: function (loading, strategy) {
                return !loading && strategy && Object.keys(strategy).length > 0;
            },

        });
    </script>

</dom-module>  
