<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/iron-selector/iron-selector.html">
<link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">

<link rel='import' href='./aq-check-authentication.html'>
<link rel='import' href='./aq-loading-progress.html'>

<dom-module id="aq-backtest-summary-element">

    <template>

        <style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning">
            :host {
                font-family: 'Lato', sans-serif;
                font-size: 14px;
            }

            .time-period {
                display: inline;
                position: relative;
                top: 12px;
                color:#cc4444;
            }

            .calendar-item {
                background-color: #f2f2f2;
                padding: 5px 10px;
                margin: 5px;
                cursor: pointer;

            }

            .calendar-item span {
                font-size: 14px;
            }

            #calendar-container {
                margin-top: 7px;
                transition: all 0.3s ease-in-out;
            }

            paper-radio-button {
                --paper-radio-button-checked-color: #cc4444;
            }

            .year-container .iron-selected , .month-container .iron-selected {
                background: #fff;
                border: 1px solid teal;
                color: teal;
            }
            .heavy-span{
                font-weight: 700;
                color:#cc4444;
            }
            .upper-container{
                margin-bottom: 20px;
                margin-left: 20px;
            }
            vaadin-grid {
                --primary-color: transparent;

            }
            .header-item{
                color:#000;
                font-weight: 700;
            }
            #container {
                display: none;
                margin-top: 30px;
                margin-bottom: 10px;
            }
          
        </style>

        <aq-check-authentication id='authItem'></aq-check-authentication>

        <div id='container' class="layout vertical flex">
            <div class="upper-container layout horizontal">
                <div class="checkbox-container layout horizontal center-justified">
                    <span class="time-period">Time Period</span>
                    <paper-radio-group selected="{{selectedButton}}" fallback-selection="0">
                        <paper-radio-button noink name="0">All</paper-radio-button>
                        <paper-radio-button noink name="1">Last 252 Days</paper-radio-button>
                        <paper-radio-button noink name="2">Custom</paper-radio-button>
                    </paper-radio-group>
                </div>
                
                <template is='dom-if' if='[[isCustomBar(selectedButton)]]'>
                    <div id="calendar-container" class="layout vertical flex">
                        <div class="calendar-item-container year-container layout horizontal">
                            <iron-selector  on-iron-select='onYearChange' attr-for-selected="year" selected="[[year]]" class="layout horizontal">
                                <template is="dom-repeat" items="{{years}}">
                                    <div year="{{item}}" class="calendar-item"><span>{{item}}</span></div>
                                </template>
                            </iron-selector>
                        </div>

                        <div class="calendar-item-container month-container layout horizontal">
                            <iron-selector on-iron-select='onMonthChange' attr-for-selected="month" selected="[[month]]" class="layout horizontal">
                                <template is="dom-repeat" items="{{months}}">
                                    <div month="{{item}}" class="calendar-item"><span>{{item}}</span></div>
                                </template>
                            </iron-selector>
                        </div>
                    </div>
                </template>
            </div>

            <span style="margin-left: 20px;">Showing Data for&nbsp<span class="heavy-span">[[durationText]]</span></span>

            <vaadin-grid>
                <table>
                    <colgroup>
                        <col>
                        <template is="dom-repeat" items="{{headers}}">
                            <col>
                        </template>
                    </colgroup>
                    <thead class="thead">
                    <tr>
                        <th class="header"><span style="color:transparent">Some</span></th>
                        <template is="dom-repeat" items="{{headers}}">
                            <th class="header"><span class="header-item">{{item}}</span></th>
                        </template>
                    </tr>
                    </thead>
                </table>
            </vaadin-grid>
        </div>
    </template>
    
    <script>
        Polymer({
            is: "aq-backtest-summary-element",
            properties: {
                data: {
                    type: Array,
                    value: []
                },
                users: {
                    type: Object,
                    value: {}
                },
                headers: {
                    type: Array,
                    value: [
                        'Total Return', 'Annual Return', 'Volatility', 'Sharpe Ratio', 'Information ratio',
                        'Max Drawdown', 'Calmar Ratio', 'Beta', 'Stability', 'Alpha'
                    ]
                },
                years: {
                    type: Array,
                },
                months: {
                    type: Array,
                    value: ['All', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                },

                compareItems: {
                    type: Array,
                    observer:'_compareItemsChanged'
                },

                selectedButton: {
                    type:String,
                    value:"0",
                    observer:'_selectedButtonChanged',
                },

            },

            _compareItemsChanged: function() {
                this.selectedButton = "0";
                
                if(this.$.container) {
                    this.$.container.style.display = 'none';
                }

                if(this.compareItems.length > 0) {
                    var indexArray = this.compareItems.map(function(x) {return x.index;})
                    var backtests = this.compareItems.map(function(x) {return x.backtest;});

                    this.resetYearsMonths(backtests);

                    this.compare();
                }
            },

            getBacktestData: function(indexArray, backtests) {
                
                var result = [];
                for(var i=0; i<backtests.length; i++){
                    
                    if(this.selectedButton=='0') {
                        
                        var summary = backtests[i].output.summary;

                        result.push([
                            indexArray[i],
                            summary.totalreturn+'%',
                            summary.annualreturn+'%',
                            summary.annualstandarddeviation+'%',
                            summary.sharperatio,
                            summary.informationratio,
                            summary.maxdrawdown+'%',
                            summary.calmarratio,
                            summary.beta,
                            summary.stability,
                            summary.alpha
                        ]);
                    } else if(this.selectedButton == '1') {
                        
                        var rolling = backtests[i].output.analytics.rolling;
                        
                        result.push([
                            indexArray[i],
                            rolling.totalreturn+'%',
                            rolling.annualreturn+'%',
                            rolling.annualstandarddeviation+'%',
                            rolling.sharperatio,
                            rolling.informationratio,
                            rolling.maxdrawdown+'%',
                            rolling.calmarratio,
                            rolling.beta,
                            rolling.stability,
                            rolling.alpha
                        ]);
                    } else if(this.selectedButton == '2') {
                        
                        var year = this.year.toString();
                        var month = this.month;

                        if(month == 'All') {
                            var yearField = backtests[i].output.analytics.fixed.yearly[year];

                            if(yearField) {

                                result.push([
                                    indexArray[i],
                                    yearField.totalreturn+'%',
                                    yearField.annualreturn+'%',
                                    yearField.annualstandarddeviation+'%',
                                    yearField.sharperatio,
                                    yearField.informationratio,
                                    yearField.maxdrawdown+'%',
                                    yearField.calmarratio,
                                    yearField.beta,
                                    yearField.stability,
                                    yearField.alpha
                                ]); 
                            } else {
                                result.push([
                                    indexArray[i],
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                ]);
                            }
                        } else {
                            var numericMonth = this.months.indexOf(month);
                            if(numericMonth < 10) {
                                numericMonth = '0' + numericMonth.toString();
                            } else {
                                numericMonth = numericMonth.toString();
                            }

                            var key = year.toString() + numericMonth;
                            var monthField = backtests[i].output.analytics.fixed.monthly[key];

                            if(monthField) {

                                result.push([
                                    indexArray[i],
                                    monthField.totalreturn+'%',
                                    monthField.annualreturn+'%',
                                    monthField.annualstandarddeviation+'%',
                                    monthField.sharperatio,
                                    monthField.informationratio,
                                    monthField.maxdrawdown+'%',
                                    monthField.calmarratio,
                                    monthField.beta,
                                    monthField.stability,
                                    monthField.alpha
                                ]); 
                            } else {
                                result.push([
                                    indexArray[i],
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                    '-',
                                ]);
                            }

                        }
                    }
                }
                return result;
            },

            compare: function() {
                
                this.$.container.style.display = 'none';

                var grid = this.$$('vaadin-grid');
                var element = this;

                var indexArray = this.compareItems.map(function(x) {return x.index;})
                
                var backtests = this.compareItems.map(function(x) {return x.backtest;});

                this.computeYearMonth();

                this.data = this.getBacktestData(indexArray, backtests);
                
                grid.items = [];

                grid.items = function (params, callback) {
                    callback(element.data.slice(params.index, params.index + params.count));
                };

                grid.size = this.data.length;

                this.$.container.style.display = 'block';

            },

            resetYearsMonths: function(backtests) {
                
                this.years = [];
                var ydict = {};
                for(var i=0; i<backtests.length; i++) {
                    
                    if(backtests[i].output.analytics.fixed.yearly) {
                        var years = Object.keys(backtests[i].output.analytics.fixed.yearly);

                        for(var j=0; j<years.length; j++) {
                            ydict[years[j]] = 1;
                        }
                        
                    }
                }

                this.years = Object.keys(ydict).sort();
                this.year = this.years[0];
                this.month = this.months[0];

            },


            isCustomBar: function(selectedButton) {
                return selectedButton == "2";
            },

            _selectedButtonChanged: function() {
                if(this.compareItems) {
                    this.compare();
                }
            },

            onMonthChange: function(e) {
                this.month = e.detail.item.month;
                this.compare();
            },

            onYearChange: function(e) {
                this.year = e.detail.item.year;
                this.compare();
            },

            computeYearMonth: function() {
                
                var selectedButton = this.selectedButton;
                var year = this.year;
                var month = this.month;

                var txt = "";

                if(selectedButton == "2") { 
                    if(month == 'All') {
                        txt = year.toString();
                    } else {
                        txt = month.toString() + ' ' + year.toString();
                    }
                } else if (selectedButton == "0") {
                    txt = "Full Duration"; 
                } else if (selectedButton == "1") {
                    txt = "Last 252 Days"; 
                }

                this.durationText = txt;
            },

        });
    </script>
</dom-module>