<link rel='import' href='../../../../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../../../../bower_components/paper-tabs/paper-tab.html'>
<link rel='import' href='../../../../bower_components/paper-card/paper-card.html'>
<link rel='import' href='../../../../bower_components/iron-signals/iron-signals.html'>
<link rel='import' href='../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../../bower_components/iron-pages/iron-pages.html'>
<link rel='import' href='../../../../bower_components/iron-selector/iron-selector.html'>
<link rel='import' href='../../../../bower_components/paper-progress/paper-progress.html'>

<link rel="import" href="../../../../bower_components/juicy-ace-editor/juicy-ace-editor.html">

<link rel='import' href='../aq-check-authentication.html'>

<link rel='import' href='./aq-backtest-metric-item.html'>
<link rel='import' href='./aq-backtest-header-item.html'>
<link rel='import' href='./aq-backtest-metric-item-list.html'>
<link rel='import' href='./aq-backtest-performance-detail-item.html'>

<script src="../../../../resources/scripts/DateTime.js"></script>

<dom-module id='v-tab'>
    <style include="iron-flex iron-flex-alignment iron-positioning">
    </style>

    <style>

        #container {
            height: 70px;
            width: 100px;
            border: 1px solid #e1e1e1;
            border-top:none;
            border-left:none;
            color: #919191;
            background-color: #f9f9f9;
            font-size: 12px;
        }

        #container.selected {
            background-color: white;
            color: #cc6666;
            border-right: none;
        }

        #container:hover {
            cursor: pointer;
            font-weight: bold;
        }

        #sidebar {
            width: 3px;
            height: 100%;
            background-color: var(--v-tab-sidebar-color, #f9f9f9);
        }

        #sidebar.selected {
            background-color: #cc6666;
        } 

        #int-container {
            margin: 0 auto;
        } 

    </style>

    <template>
        <div id="container" class$="[[computeSelectedClass(selected)]] layout horizontal center">
            
            <div id="sidebar" class$="[[computeSelectedClass(selected)]]">
            </div>
            
            <div id="int-container" class="layout vertical center">
                <iron-icon icon="[[icon]]"></iron-icon>
                <content></content>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'v-tab',

            properties: {
                icon: String,
                selected: Boolean,
            },

            computeSelectedClass: function(selected) {
                return selected ? "selected" : "";
            }

        });
    </script>
</dom-module>

<dom-module id='aq-forwardtest-detail-item'>
    <style include="iron-flex iron-flex-alignment iron-positioning">
    </style>

    <style>
        paper-tabs {
            --paper-tabs-selection-bar-color: #cc6666;

            --paper-tabs: {
                margin-bottom: 10px;
            };
        }

        .lower-container {
            margin-top: 10px;
            --background-color: #f5f5f5;
            --padding-left: 20px;
        }

        .middle-container {
            padding-top: 10px;
        }

        paper-card {
        	--paper-card:{
	        	color: #2f2f2f;
	            margin: 0 auto;
	            height: 100%;
	            --background-color: var(--aq-forwardtest-detail-item-background-color, #fff);
            }
        }

        .card-content {
        	color: #2f2f2f;
            --padding-left: 0px;
            --padding-right: 0px;
            padding-top: 0px;
        }

        #tab-container {
            border-bottom: 1px solid #e1e1e1;
            height: 47px;
        }

        .forwardtest-detail {
            margin-top: 15px;
            border: 1px solid #e1e1e1;
            width: 100%;
        }

        #performance-container {
            --border: 1px solid #e1e1e1;
            width: 100%;
        }

        #code-container {
            min-height: 200px;
            --padding-top: 10px;
        }        

        juicy-ace-editor {
            border: 1px solid #e1e1e1;
            --border-top: none;
            --border-left: none;
        }

        #iron-page-container {
            width: 80%;
            margin: 0 auto;
            margin-top: 25px;
            margin-bottom: 10px;
            min-height: 400px;
        }

        paper-button {
            --paper-button:{
                color: white;
                background-color: #cc6666;
                height: 24px;
                font-size: 12px;
            };
        }

        #ft-name {
            font-size: 18px;
            font-weight: 700;
        }

        .label-text {
            font-size: 12px;
            margin-top: 5px;
        }

        #label-text-running {
            margin-top: 0px !important; 
            font-size: 14px;  
        }

        #status-box {
            width: 7px;
            height: 7px;
            background-color: green;
            margin-right: 5px;
        }

        #status-container {
            margin-top: 5px;
        }

        .heading {
            font-size: 16px;
            --margin-top: 10px;
            margin-bottom: 10px;
            font-weight: 700;
            --margin-left: -20px;
            color: #555555;
        }

    </style>

    <template>

        <aq-check-authentication id='authItem'></aq-check-authentication>
    	<div class="layout vertical">
            <template is='dom-if' if='[[forwardtestHeader]]'>
                <div class="top-container layout horizontal">
                    <div class="layout vertical">
                        <div id="ft-name">LIVE TEST for [[forwardtestHeader.strategyName]]</div>
                            
                        <div class="label-text">Created At:&nbsp[[forwardtestHeader.createdAt]]</div>
                        <div class="label-text">Last updated:&nbsp[[forwardtestHeader.updatedAt]]</div>
                        
                    </div>
                    <div class="flex"></div>
                    <div class="layout vertical center">
                        <paper-button on-tap='stopTest' noink>STOP LIVE TEST</paper-button>
                        <div id='status-container' class="layout horizontal">
                            <div id="status-box" class="self-center"></div>
                            <div class="label-text" id="label-text-running">[[forwardtestHeader.status]]</div>
                        </div>
                    </div>
                </div>
    		</template>
            
            <div class="middle-container flex">
            	<template is='dom-if' if='{{metrics}}'>
            		<aq-forwardtest-metric-item-list 
                        heading="Metrics"
            			forced-semi-wide = "[[forcedSemiWide]]"
            			metric-items = "{{metrics}}">
        			</aq-forwardtest-metric-item-list> 
            	</template>
            </div>

            <div class="forwardtest-detail layout horizontal">
                <div class="layout" id="vertical-tab-container">
	                <iron-selector selected="{{detailType}}" 
                        fallback-selection="0">
	                    <v-tab selected=[[isSelected(detailType,0)]] icon="vaadin-icons:line-bar-chart" add">Performance
                        </v-tab>
                        
                        <v-tab selected=[[isSelected(detailType,1)]] icon="vaadin-icons:code">Code
                        </v-tab>
                        
                        <v-tab selected=[[isSelected(detailType,2)]] icon="vaadin-icons:suitcase">Portfolio
                        </v-tab>
                        
                        <v-tab selected=[[isSelected(detailType,3)]] icon="aq-icons:view-list">Transactions</v-tab>
                        
                        <v-tab selected=[[isSelected(detailType,4)]] icon="add">Logs</v-tab>
                    </iron-selector>
                </div>
                
                <div id='iron-page-container'>
                <iron-pages selected="{{detailType}}">
                    <div id="performance-container">
                        <div class="heading">PERFORMANCE</div>
                        <div style="border: 1px solid #e1e1e1">
                            <aq-backtest-performance-detail-item 
                                backtest="[[forwardtest]]">
                            </aq-backtest-performance-detail-item>
                        </div>
                    </div>

                    <div id="code-container">
                        <div class="heading">CODE</div>
                        <juicy-ace-editor readonly style="height:100%; min-height: 400px;" theme="ace/theme/xcode" mode="ace/mode/julia" fontsize="14px" id="codeEditor" tabsize="4">"Code"
                        </juicy-ace-editor>
                    </div>
                    <div></div>
                    <div></div>
                    <div></div>
                </iron-pages>
                </div>
            </div>
      	</div>

        <iron-ajax
            url="[[computeGetForwardtestUrl(forwardtestId)]]"
            method='GET'
            id='getForwardtestQuery'
            handle-as="json"
            on-response="onGetForwardtestSuccess"
            on-error="onGetForwardtestError"
            headers='{{header}}'
            debounce-duration="300"
            loading='{{loading}}'>
        </iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'aq-forwardtest-detail-item',

            properties: {
                metrics: Object,

                detailType:{
                    type: Number,
                    value:0,
                },

                forwardtestId: {
                    type: String,
                    observer: '_forwardtestIdChanged',
                },

                forwardtest: Object,

                header: Object,

                APIEndPoint: String,

                loading: {
                    type: Boolean,
                    readOnly: true,
                    notify: true,
                    value: false
                },

                forcedSemiWide: {
                	type: Boolean,
                	value: false,
                },

            },

            isSelected: function(detailType, val) {
                return detailType == val;
            },

            _forwardtestIdChanged: function (nId, oId) {
                console.log("hola");
                if (nId && nId!= "") {
                    this.reset();
                    this.requestStaticData();
                }
            },

            computeGetForwardtestUrl: function (forwardtestId) {
                var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                return APIEndPoint + '/forwardtest/' + forwardtestId;
            },

            reset: function () {
                this.$$('aq-backtest-performance-detail-item').reset();
                this.resetMetrics();
            },

            resetMetrics: function () {
                this.metrics = [{
                    "metricName": "Total Return",
                    "metricValue": "-",
                    "metricDescription": "Total Return"
                },
                {
                    "metricName": "Annual Return",
                    "metricValue": "-",
                    "metricDescription": "Annual Return",
                },
                {
                    "metricName": "Volatility",
                    "metricValue": "-",
                    "metricDescription": "Volatility"
                },
                {
                    "metricName": "Sharpe Ratio",
                    "metricValue": "-",
                    "metricDescription": "Sharpe Ratio"
                },
                {
                    "metricName": "Information Ratio",
                    "metricValue": "-",
                    "metricDescription": "Information Ratio"
                },
                {
                    "metricName": "Sortino Ratio",
                    "metricValue": "-",
                    "metricDescription": "Sortino Ratio"
                },
                {
                    "metricName": "Avg. Drawdown",
                    "metricValue": "-",
                    "metricDescription": "Avg. Drawdown"
                },
                {
                    "metricName": "Max Drawdown",
                    "metricValue": "-",
                    "metricDescription": "Max Drawdown"
                },
                {
                    "metricName": "Calmar Ratio",
                    "metricValue": "-",
                    "metricDescription": "Calmar Ratio"
                },
                {
                    "metricName": "Beta",
                    "metricValue": "-",
                    "metricDescription": "Beta"
                },
                {
                    "metricName": "Stability",
                    "metricValue": "-",
                    "metricDescription": "Stability"
                },
                {
                    "metricName": "Avg. Concentration",
                    "metricValue": "-",
                    "metricDescription": "Avg. Concentration"
                },];
            },

            requestStaticData: function () {
                console.log("kakak");
                if (this.forwardtestId && this.$.authItem.checkHasToken()) {
                    this.header = this.$.authItem.getHeader();
                    console.log("alala");
                    this.$.getForwardtestQuery.generateRequest();
                }
            },

            onGetForwardtestSuccess: function (e) {

                console.log(e.detail.response);
                this.set('forwardtest', e.detail.response);

                this.forwardtestHeader = 
                {
                    "createdAt": date.formatDateTime(this.forwardtest.createdAt), 
                  
                    "updatedAt": this.forwardtest.updatedAt ? date.formatDateTime(this.forwardtest.updatedAt): "", 

                    "status":!this.forwardtest.error ? "Running" : "Stopped",
                };
                
                if (this.forwardtest.output && this.forwardtest.output.analytics && this.forwardtest.output.analytics.rolling) {
                    this.addMetricData(this.forwardtest.output.analytics.rolling);
                }

                if (this.forwardtest.output.variables) {
                    // this variable is used because array changes are somehow not relaying back the template
                    this.hasTrackVarData = true;
                }

                this.$$('aq-backtest-performance-detail-item'). updateGraphProperties(this.hasTrackVarData);

                this.$$('aq-backtesttest-performance-detail-item').plotGraphs(); 
            },

            onGetForwardTestError: function (e) {
                console.log(e);
            },

            addMetricData: function (data) {
                this.metrics = [{
                    "metricName": "Total Return",
                    "metricValue": data.totalreturn.toString() + '%',
                    "metricDescription": "Total Return"
                },
                    {
                        "metricName": "Annual Return",
                        "metricValue": data.annualreturn.toString() + '%',
                        "metricDescription": "Annual Return",
                    },
                    {
                        "metricName": "Volatility",
                        "metricValue": data.annualstandarddeviation.toString() + '%',
                        "metricDescription": "Volatility"
                    },
                    {
                        "metricName": "Sharpe Ratio",
                        "metricValue": data.sharperatio,
                        "metricDescription": "Sharpe Ratio"
                    },
                    {
                        "metricName": "Information Ratio",
                        "metricValue": data.informationratio,
                        "metricDescription": "Information Ratio"
                    },
                    //{"metricName":"Sortino Ratio", "metricValue":"2.5", "metricDescription":"Sortino Ratio"},
                    //{"metricName":"Avg. Drawdown", "metricValue":data.drawdown.toFixed(2).toString()+'%', "metricDescription":"Avg. Drawdown"},
                    {
                        "metricName": "Max Drawdown",
                        "metricValue": data.maxdrawdown.toString() + '%',
                        "metricDescription": "Max Drawdown"
                    },
                    {
                        "metricName": "Calmar Ratio",
                        "metricValue": data.calmarratio,
                        "metricDescription": "Calmar Ratio"
                    },
                    {"metricName": "Beta", "metricValue": data.beta, "metricDescription": "Beta"},
                    {
                        "metricName": "Stability",
                        "metricValue": (data.stability) ? data.stability : "-",
                        "metricDescription": "Stability"
                    },
                    {"metricName": "Alpha", "metricValue": data.alpha.toString() + '%', "metricDescription": "Alpha"},
                    //{"metricName":"Avg. Concentration", "metricValue":"0.43", "metricDescription":"Avg. Concentration"},
                ];
            },

            deepCopy: function(array) {
				return JSON.parse(JSON.stringify(array));
			},
        });
    </script>
    
</dom-module>



