<link rel='import' href='../../../../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../../../../bower_components/paper-tabs/paper-tab.html'>
<link rel='import' href='../../../../bower_components/paper-card/paper-card.html'>
<link rel='import' href='../../../../bower_components/iron-signals/iron-signals.html'>
<link rel='import' href='../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../../bower_components/iron-pages/iron-pages.html'>
<link rel='import' href='../../../../bower_components/paper-progress/paper-progress.html'>
<link rel="import" href="../../../../bower_components/juicy-ace-editor/juicy-ace-editor.html">

<link rel='import' href='../aq-check-authentication.html'>

<link rel='import' href='./aq-backtest-metric-item.html'>
<link rel='import' href='./aq-backtest-header-item.html'>
<link rel='import' href='./aq-backtest-metric-item-list.html'>
<link rel='import' href='./aq-backtest-performance-detail-item.html'>

<link rel="import" href="../aq-log-item-new.html">
<link rel="import" href="../aq-transaction-table.html">
<link rel="import" href="../aq-portfolio-table.html">

<dom-module id='aq-backtest-detail-item'>
    <style include="iron-flex iron-flex-alignment iron-positioning">
    </style>

    <style>
        paper-tabs {
            --paper-tabs-selection-bar-color: #cc6666;

            --paper-tabs: {
                margin-bottom: 10px;
            };
        }

        .middle-container {
            margin-top: 10px;
            --background-color: #f5f5f5;
            --padding-left: 20px;
        }

        #container {
            padding: 15px;
            background-color: white;
            height: 100%;
        }

        paper-card {
        	--paper-card:{
	        	color: #3c3c3c;
	            margin: 0 auto;
	            height: 100%;
	            --background-color: var(--aq-backtest-detail-item-background-color, #fff);
            }
        }

        .card-content {
        	color: #3c3c3c;
            --padding-left: 0px;
            --padding-right: 0px;
            --padding-top: 0px;

        }

        #tab-container {
            border-bottom: 1px solid #e1e1e1;
            height: 47px;
            background-color: #fafafa;
        }

        .backtest-detail {
            margin-top: 15px;
            border: 1px solid #e1e1e1;
        }

        #performance-container {
            padding-top: 15px;
        }
        
        #code-container {
            min-height: 200px;
            margin-top: 20px;
        }

        #log-container {
            height: 400px;
            overflow-y: scroll;
            margin-top: 20px;
            background-color: #323232;
        }

        #transaction-container {
            height: 400px;
            overflow-y: scroll;
            color: #3c3c3c;
            margin: 20px 20px 20px 20px;
        }

        #portfolio-container {
            height: 400px;
            overflow-y: scroll;
            color: #3c3c3c;
            margin: 20px 20px 20px 20px;
        }
    </style>

    <template>
        <aq-check-authentication id='authItem'></aq-check-authentication>

        <template is='dom-if' if='[[!loading]]'>
            
            <div id='container' class="layout vertical flex">
            	<template is='dom-if' if='[[backtestHeader]]'>
            		<aq-backtest-header-item
                        heading="[[heading]]"
            			forced-semi-wide = "[[forcedSemiWide]]"
            			header-items="{{backtestHeader}}" 
                        can-share="[[canShare]]"
                        can-clone="[[canClone]]">
            		</aq-backtest-header-item>
        		
                    <div class="bar"></div>
                </template>

                <template is='dom-if' if='{{metrics}}'>
                    <div class="middle-container flex">
                		<aq-backtest-metric-item-list 
                            heading="Backtest Metrics"
                			forced-semi-wide = "[[forcedSemiWide]]"
                			metric-items = "{{metrics}}"
                			active="{{active}}">
            			</aq-backtest-metric-item-list>
                    </div> 
            	</template>

                <div class="backtest-detail">
                    
                    <template is='dom-if' if='[[!active]]'>
                        <div class="layout" id="tab-container">
        	                <paper-tabs noink selected="{{detailType}}" fallback-selection="0">
        	                    <paper-tab>Performance</paper-tab>
                                
                                <paper-tab>Code</paper-tab>

                                <template is='dom-if' if='[[backtestPositions]]'>
                                    <paper-tab>Portfolio</paper-tab>
                                </template>
                                
                                <template is='dom-if' if='[[backtestTransactions]]'>
                                    <paper-tab>Transactions</paper-tab>
                                </template>

                                <template is='dom-if' if='[[backtestLogs]]'>
                                    <paper-tab>Log</paper-tab>
                                </template>
                            </paper-tabs>
                        </div>
                    </template>
                    
                    <iron-pages selected="{{detailType}}">
                        <div id="performance-container">
                            <aq-backtest-performance-detail-item
                                    active="[[active]]"
                                    error="[[internalError]]"
                                    backtest="[[backtest]]">
                            </aq-backtest-performance-detail-item>
                        </div>
                        
                        <div id="code-container">
                            <juicy-ace-editor readonly style="height:100%; min-height: 400px;" theme="ace/theme/xcode" mode="ace/mode/julia" fontsize="14px" id="codeEditor" tabsize="4">[[backtest.code]]
                            </juicy-ace-editor>
                        </div>
                        
                        <template is='dom-if' if='[[backtestPositions]]'>
                            <div id="portfolio-container">
                                <aq-portfolio-table 
                                    positions="[[backtestPositions]]">
                                </aq-portfolio-table>
                            </div>
                        </template>

                         <template is='dom-if' if='[[backtestTransactions]]'>
                            <div id="transaction-container">
                                <aq-transaction-table 
                                    transactions="[[backtestTransactions]]"
                                    no-proposed-orders>
                                </aq-transaction-table>
                            </div>
                        </template>

                        <template is='dom-if' if='[[backtestLogs]]'>
                            <div id="log-container">
                                <template is='dom-repeat' items="[[backtestLogs]]">
                                    <aq-log-item-new 
                                        datetime="[[item.datetime]]"
                                        message="[[item.message]]"
                                        message-type="[[item.messagetype]]">
                                    </aq-log-item-new>
                                </template>
                            </div>    
                        </template>
                    </iron-pages>
                </div>
            </div>
        </template>
      
        <iron-signals on-iron-signal-point-data='onBacktestSinglePointData'></iron-signals>

        <iron-signals on-iron-signal-backtest-completed='onBacktestCompletion'></iron-signals>

        <iron-signals on-iron-signal-backtest-completed='onBacktestException'></iron-signals>

        <iron-signals on-iron-signal-bulk-data='onBacktestBulkData'></iron-signals>

        <iron-ajax
            url="[[computeGetBacktestUrl(backtestId)]]"
            method='GET'
            id='getBacktestQuery'
            handle-as="json"
            on-response="onGetBacktestSuccess"
            on-error="onGetBacktestError"
            headers='{{header}}'
            debounce-duration="300"
            loading="{{loading}}">
        </iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'aq-backtest-detail-item',

            properties: {

                hide: {
                    type: Boolean,
                    value: true,
                },

                active: {
                    type: Boolean,
                    value: false,
                    observer: '_activeChanged',
                },

                metrics: Object,

                detailType:{
                    type: Number,
                    value:0,
                    observer:'_detailTypeChanged',
                },

                backtestId: {
                    type: String,
                    observer: '_backtestIdChanged',
                },

                backtest: Object,

                header: Object,

                APIEndPoint: String,

                loading: {
                    type:Boolean,
                    notify: true,
                },

                forcedSemiWide: {
                	type: Boolean,
                	value: false,
                },

                canShare: {
                    type: Boolean,
                    value: false,
                },

                canClone: {
                    type: Boolean,
                    value: false,
                },

                heading: String,

                backtestLogs: Array,

                backtestTransactions: Array,

                backtestPositions: Array,
            },

            listeners: {
                'share-clicked':'goToShare',
            },

            goToShare: function(e) {
                this.fire('rt-changed' ,{route:'/dashboard/community/create?backtestId='+ this.backtestId});
            },

            //WHICH ONE TO USE atteched ot this observer??/
            //Observer works
            _backtestIdChanged: function() {
                if(this.backtestId) {
                    this.requestStaticData();
                }
            },

            attached: function() {
                //this.requestStaticData();
            }, 

            resize: function() {
                this.$$('aq-backtest-performance-detail-item').onResize();
            },

            _activeChanged: function() {
                if(!this.active && this.backtestId != "") {
                    this.fire('unsubscribe-data',{backtestId:this.backtestId});
                    this.reset();
                }
            },

            computeGetBacktestUrl: function (backtestId) {
                var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                return APIEndPoint + '/backtest/' + backtestId;
            },

            reset: function () {
                this.set('backtestHeader', []);
                this.resetMetrics();
                //this.set('backtestTransactions',[]);
                //this.set('backtestPositions', []);
                //this.set('backtestLogs',[]);

                if(this.$$('aq-backtest-performance-detail-item')) {
                    this.$$('aq-backtest-performance-detail-item').reset(); 
                } else {
                    this.async(function() 
                        {
                            if(this.$$('aq-backtest-performance-detail-item')) {
                                    this.$$('aq-backtest-performance-detail-item').reset();
                                }
                        }, 200); 
                }
            },

            resetMetrics: function () {
                this.metrics = [{
                    "metricName": "Total Return",
                    "metricValue": "-",
                    "metricDescription": "Total Return"
                },
                {
                    "metricName": "Annual Return",
                    "metricValue": "-",
                    "metricDescription": "Annual Return",
                },
                {
                    "metricName": "Volatility",
                    "metricValue": "-",
                    "metricDescription": "Volatility"
                },
                {
                    "metricName": "Sharpe Ratio",
                    "metricValue": "-",
                    "metricDescription": "Sharpe Ratio"
                },
                {
                    "metricName": "Information Ratio",
                    "metricValue": "-",
                    "metricDescription": "Information Ratio"
                },
                {
                    "metricName": "Sortino Ratio",
                    "metricValue": "-",
                    "metricDescription": "Sortino Ratio"
                },
                {
                    "metricName": "Avg. Drawdown",
                    "metricValue": "-",
                    "metricDescription": "Avg. Drawdown"
                },
                {
                    "metricName": "Max Drawdown",
                    "metricValue": "-",
                    "metricDescription": "Max Drawdown"
                },
                {
                    "metricName": "Calmar Ratio",
                    "metricValue": "-",
                    "metricDescription": "Calmar Ratio"
                },
                {
                    "metricName": "Beta",
                    "metricValue": "-",
                    "metricDescription": "Beta"
                },
                {
                    "metricName": "Stability",
                    "metricValue": "-",
                    "metricDescription": "Stability"
                },
                {
                    "metricName": "Avg. Concentration",
                    "metricValue": "-",
                    "metricDescription": "Avg. Concentration"
                },];
            },

            subscribeData: function () {
                
                //this.fire('subscribe-data', {backtestId: this.backtestId});
                /*this.async(function () {
                    this.fire('subscribe-data', {backtestId: this.backtestId})
                }, 1000);*/
            },

            onBacktestSinglePointData: function (e) {
                
                //process data only when element is active
                if (!this.active) {
                    return
                }

                data = e.detail;

                if ((data.outputtype == "performance" || data.outputtype == "labels") && this.active) {
                    
                    if (data.outputtype == "performance") {
                        this.addMetricData(data);
                    }

                    //Send flag whether to send signals after data update
                    this.$$('aq-backtest-performance-detail-item').addRealTimeData(data);

                } else if (data.outputtype == "log" && data.messagetype == "ERROR") {
                        
                    //Update backtest header
                    //*****HARDCODED******
                   
                    var btHeader = this.deepCopy(this.backtestHeader);
                    btHeader[3]["metric"] = "Exception";
                    this.$$('aq-backtest-header-item').updateHeaderItems(btHeader);

                    this.async(
                        function() {
                            this.fire('iron-signal', {name:'backtest-exception', data:{type: 2, id: this.backtestId}});
                            

                        }, 1000);

                } 
            },

            onBacktestException: function(e) {
                this.backtestHeader[3].metric = "Complete";
                var backtestHeader = this.deepCopy(this.backtestHeader);
                this.backtestHeader = [];
                this.backtestHeader = backtestHeader;              
            },

            onBacktestCompletion: function(e) {
                this.backtestHeader[3].metric = "Exception";
                var backtestHeader = this.deepCopy(this.backtestHeader);
                this.backtestHeader = [];
                this.backtestHeader = backtestHeader;
            },

            requestStaticData: function () {
                if (this.backtestId && this.$.authItem.checkHasToken()) {
                    this.header = this.$.authItem.getHeader();
                    this.$.getBacktestQuery.generateRequest();
                }
            },

            onGetBacktestSuccess: function (e) {
                
                    //first reset Metrics 
                    this.reset();
                    this.set('backtest', e.detail.response);
                    this.backtestHeader = 
                    [
                        {   
                            label: "Strategy Name",
                            metric: this.backtest.strategy_name, 
                        }, 
                        {   
                            label: "Created At",
                            metric: date.formatDateTime(this.backtest.createdAt), 
                        }, 

                        {
                            label: "Date Range",
                            metric: date.formatDate(this.backtest.settings.startDate) + " - " + date.formatDate(this.backtest.settings.endDate),
                        },

                        {
                            label: "Status",
                            metric: this.backtest.status.charAt(0).toUpperCase() + this.backtest.status.slice(1),
                        }
                    ];

                    //Compute and populate the transactions, portfolio and logs after a delay of 5 seconds each OR when tab pressed
                    this.computePortfolio(this.backtest);
                    this.computeTransactions(this.backtest);
                    this.computeLogs(this.backtest);

                    if (this.backtest.status == "exception") {
                            this.fire('iron-signal', {name:'backtest-exception', data:{type: 1, id: this.backtestId}});
                        return ;
                    }        
            
                    if (this.backtest.status == "active") {
                        this.active = true;
                        this.subscribeData();
                        return;
                    }

                    var metrics = this.backtest.output ? this.backtest.output.performance ?  this.backtest.output.performance.detail ? this.backtest.output.performance.detail.analytics ? this.backtest.output.performance.detail.analytics.rolling : null : null : null: null;
                    
                    if (metrics) {
                        this.addMetricData(metrics);
                    }

                    /*if (this.backtest.output.variables) {
                        // this variable is used because array changes are somehow not relaying back the template
                        this.hasTrackVarData = true;
                    }

                    this.$$('aq-backtest-performance-detail-item'). updateGraphProperties(this.hasTrackVarData);*/
                    this.async(function() {
                        this.$$('aq-backtest-performance-detail-item').plotGraphs();
                    }, 500);
            },

            onGetBacktestError: function (e) {
                console.log(e);
            },

            computeLogs:function(backtest) {
                
                if(!this.backtestLogs || this.backtestLogs.length == 0) {
                    //NEW data format
                    var logs = backtest ? (backtest.output ? (backtest.output.logs ? (backtest.output.logs.values ? backtest.output.logs.values : null)  : null) : null) : null;

                    if(logs) {
                        //var logs = logs.values;
                        var logArray = [];
                        
                        Object.keys(logs).sort().forEach(date => {
                            var logsForDate = logs[date];

                            Object.keys(logsForDate).sort().forEach(datetime => {
                                var logs = logsForDate[datetime];
                                logs.forEach(log => {
                                    logArray.push(JSON.parse(log));
                                });        
                            });
                        });

                        this.backtestLogs = logArray;
                    } 
                }
            },

            computeTransactions:function(backtest) {
                
                if(!this.backtestTransactions || this.backtestTransactions.length == 0) {
                    var transactionHistory = backtest ? (backtest.output ? (backtest.output.transactionHistory ? backtest.output.transactionHistory : null) : null) : null;

                    if(transactionHistory) {

                        var trueTransactionHistory = [];

                        transactionHistory.forEach(obj => {
                            trueTransactionHistory = trueTransactionHistory.concat(obj.values);

                        });

                        var transactionArray = []
                        trueTransactionHistory.forEach(obj => {
                            
                            var transactionsEachDay = obj.transactions;
                            //array of array
                            transactionsEachDay.forEach(transaction => {
                                transactionArray.push(transaction);    
                            })
                            
                        });

                        this.backtestTransactions = transactionArray;

                    } 
                }
            },

            computePortfolio:function(backtest) {
                if(!this.backtestPositions || this.backtestPositions.length == 0) {
                    var portfolioHistory = backtest ? (backtest.output ? (backtest.output.portfolioHistory ? backtest.output.portfolioHistory: null) : null) : null;

                    //Portfolio History is multiple objects with 100 size array each


                    if(portfolioHistory) {

                        var truePortfolioHistory = [];

                        portfolioHistory.forEach(obj => {
                            truePortfolioHistory = truePortfolioHistory.concat(obj.values);
                        });
                        
                        var positionsArray = []
                        truePortfolioHistory.forEach(obj => {
                            var date = obj.date;
                            //WEIRD but that's how the data is stored
                            var portfolioEachDay = obj.portfolio.portfolio;

                            if(portfolioEachDay.positions) {
                            //array of array
                                Object.keys(portfolioEachDay.positions).forEach(pkey => {
                                    var position = portfolioEachDay.positions[pkey];
                                    
                                    if(position.quantity > 0) {
                                        position.date = date;
                                        positionsArray.push(position);    
                                    }
                                });
                            }
                            
                        });

                        this.backtestPositions = positionsArray;
                    } 
                }
            },

            addMetricData: function (data) {
                this.metrics = [{
                    "metricName": "Total Return",
                    "metricValue": data.totalreturn.toString() + '%',
                    "metricDescription": "Total Return"
                },
                    {
                        "metricName": "Annual Return",
                        "metricValue": data.annualreturn.toString() + '%',
                        "metricDescription": "Annual Return",
                    },
                    {
                        "metricName": "Volatility",
                        "metricValue": data.annualstandarddeviation.toString() + '%',
                        "metricDescription": "Volatility"
                    },
                    {
                        "metricName": "Sharpe Ratio",
                        "metricValue": data.sharperatio,
                        "metricDescription": "Sharpe Ratio"
                    },
                    {
                        "metricName": "Information Ratio",
                        "metricValue": data.informationratio,
                        "metricDescription": "Information Ratio"
                    },
                    //{"metricName":"Sortino Ratio", "metricValue":"2.5", "metricDescription":"Sortino Ratio"},
                    //{"metricName":"Avg. Drawdown", "metricValue":data.drawdown.toFixed(2).toString()+'%', "metricDescription":"Avg. Drawdown"},
                    {
                        "metricName": "Max Drawdown",
                        "metricValue": data.maxdrawdown.toString() + '%',
                        "metricDescription": "Max Drawdown"
                    },
                    {
                        "metricName": "Calmar Ratio",
                        "metricValue": data.calmarratio,
                        "metricDescription": "Calmar Ratio"
                    },
                    {"metricName": "Beta", "metricValue": data.beta, "metricDescription": "Beta"},
                    {
                        "metricName": "Stability",
                        "metricValue": (data.stability) ? data.stability : "-",
                        "metricDescription": "Stability"
                    },
                    {"metricName": "Alpha", "metricValue": data.alpha.toString() + '%', "metricDescription": "Alpha"},
                    //{"metricName":"Avg. Concentration", "metricValue":"0.43", "metricDescription":"Avg. Concentration"},
                ];
            },

            deepCopy: function(array) {
				return JSON.parse(JSON.stringify(array));
			},

            _detailTypeChanged: function() {
                return;
                if(this.detailType == 2) {
                    this.computePortfolio();
                }

                if(this.detailType == 3 ) {
                    this.computeTransactions();
                }

                if(this.detailType == 4) {
                    this.computeTransactions();
                }

            }
        });
    </script>
    
</dom-module>

