<link rel='import' href='../../../bower_components/nvd3-elements/nvd3-multi-bar.html'>
<link rel='import' href='../../../bower_components/nvd3-elements/nvd3-line.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tab.html'>
<link rel='import' href='../../../bower_components/paper-card/paper-card.html'>
<link rel='import' href='../../../bower_components/iron-signals/iron-signals.html'>
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>

<link rel='import' href='./aq-backtest-metric-item.html'>

<dom-module id='aq-backtest-detail-item'>
	<style  include="iron-flex iron-flex-alignment iron-positioning">
	</style>
  
	<style> 
		#netValueLineChart {
			--width:100%;
			--height:70%;
		}
		chart-bar {
			width: 5%;
			height:5%;
		}
		.detail {
			margin:10px;
			--margin-bottom:0px !important;
			--height:250px;
			width:50%;
		}	

		.detailmetric {
			--border:1px solid teal;
			height:73px;
			--border-bottom:1px solid teal;
			--border-right:1px solid teal;

		}

		.detailmetric span{
			vertical-align: center;
			text-align: center;
			margin-top:15px;

		}

		.mdcontainer {
			margin-left:10px;
			margin-right:10px;
			--margin-top:5px;
			margin-bottom:8px;
			height:62px;
		}

	
		#detail-header {
			margin-top:0px;
			margin-bottom: 20px;
			margin-left:10px;
			font-weight: bold;
		}

		.chart {
			width:95%;
		}
		.tooltip:{
			margin-top: -10px;

		}
		.width_tab{
			width: 144px;
		}
		.wrap    { 
		  -webkit-flex-wrap: wrap;
		  flex-wrap: wrap;
		}  

		.paper_body {
			width: 98%;
		    text-align: -webkit-center;
		    color:#24293d;
		    border:1px solid teal;
		    
		}

		.flex_container{
			display: flex;
		}
		
		paper-tabs {
			--paper-tabs-selection-bar-color:teal;

			--paper-tabs:{
				--height:100%;
				margin-bottom:10px;
			};
		}

	</style>

	<template>
		<div class="layout">
			<paper-card class="flex detail layout vertical paper_body">
				<div id='detail-header' class="layout horizontal">
					<span class="self-center">Equity Curve</span>
					<div class="flex"></div>	
					<div class="toggle_tab">
						<div>
							<paper-tabs noink selected="{{graphType}}">
								<paper-tab>Cum. Return</paper-tab>
								<template is='dom-if' if='[[!active]]'>
									<!--paper-tab>Net Value</paper-tab-->
									<paper-tab>Monthly Returns</paper-tab>
								</template>
							</paper-tabs>
						</div>
					</div>
				</div>
				
				<iron-pages selected="{{graphType}}">
				
				<!--template is='dom-if' if="[[netValueData]]"-->

					<nvd3-line 
			  			id="cumRetLineChart" 
			  			height=300
			  			show-legend 
			  			use-interactive-guideline 
			  			auto-resize
			  			no-data="Fetching Data" 
			  			data="[[cumRetData]]">
			  		</nvd3-line>

			  		<template is='dom-if' if='[[!active]]'>
					<!--nvd3-line 
			  			id="netValueLineChart" 
			  			height=300
			  			show-legend 
			  			use-interactive-guideline 
			  			auto-resize
			  			no-data="Fetching Data" 
			  			data="[[netValueData]]">
			  		</nvd3-line-->
		  		<!--/template-->

		  		<!--template is='dom-if' if="[[cumRetData]]"-->
					
		  		<!--/template-->
			      
			    <!--template is='dom-if' if="[[barData]]"-->    
			  		<nvd3-multi-bar 
			  			id="barChart" 
	  				 	height="300" 
	  				 	class="bar" 
  					 	auto-resize 
	  				 	show-legend
	  				 	use-interactive-guideline 
	  				 	no-data="Fetching Data"
	  				 	data="[[barData]]">	 	
	  				 </nvd3-multi-bar>
	  				 </template>
		  		<!--/template-->
	
		  		</iron-pages>
			      

				<div id='detail-header' class="layout horizontal flex">
					<span class="self-center">Risk Metrics</span>
					<div class="flex"></div>	
				</div>

				<div class="wrap flex_container">
					<template is="dom-repeat" items="{{metrics}}">
						<div class="layout horizontal flex mdcontainer">
							<aq-backtest-metric-item class="flex width_tab" metric-name={{item.metricName}} 
								metric-value={{item.metricValue}}
								metric-desc={{item.metricDescription}}>
							</aq-backtest-metric-item>
						</div>
					</template>			
				</div>
			</paper-card>	
		</div>

		<iron-signals id='datasignal' on-iron-signal-point-data='onBacktestData' on-iron-signal-bulk-data='onBacktestData'></iron-signals>

		<iron-ajax
          	url="http://localhost:3002/api/v2/backtest/[[backtestId]]"
     	 	method='GET'
          	id='getBacktestsQuery'
          	handle-as="json"
          	on-response="onGetBacktestSuccess"
          	on-error="onGetBacktestError"
          	headers='{{header}}'
          	debounce-duration="300">
        </iron-ajax>
			
	</template>
	<script>
		Polymer ({
			is:'aq-backtest-detail-item',
			
			properties:{
				hide: {
					type: Boolean,
					value: true,
				},

				active:{
					type:Boolean,
					value:false,
					observer:'_isActiveChanged',
				},

				metrics:Object,

				graphType: {
					type:Number,
					value:0,
				},

				netValueData: {
					type:Object, 
					value:[],
				},

				cumRetData:{
					type:Object,
					value:[],
				},

				maxLineData:{
					type:Number,
					value:-Infinity,

				},

				minLineData:{
					type:Number,
					value: Infinity,
				},

				counter:{
					type:Number,
					value:0,
				},

				barData: {
					type:Object,
					value:[], 
				},

				count:{
					type:Number,
					value:0,
				},

				backtestId:String,

				backtest:Object,
				
				scale:{
					type:Number,
					value:1,
				},

			},

			attached: function() {

				var x = localStorage.getItem('my-app-storage');
		        var user = JSON.parse(x).user;
		        if (user.token) {
		          this.header = {
		            "aimsquant-token": user.token,
		            "Content-Type": "application/json"};  
		        }

				this.metrics = [{
				            		"metricName":"Total Return", 
				            		"metricValue":"-", 
				            		"metricDescription":"Total Return"
				            	},
								{
									"metricName":"Annual Return",
									"metricValue":"-",
									"metricDescription":"Annual Return",
								},
								{
									"metricName":"Volatility",
								 	"metricValue":"-", 
								 	"metricDescription":"Volatility"
								},
								{
									"metricName":"Sharpe Ratio", 
									"metricValue":"-",
									"metricDescription":"Sharpe Ratio"
								},
								{
									"metricName":"Information Ratio",
									"metricValue":"-",
								 	"metricDescription":"Information Ratio"
								},
								{	
									"metricName":"Sortino Ratio",
									"metricValue":"-",
									"metricDescription":"Sortino Ratio"
								},
								{	
									"metricName":"Avg. Drawdown",
								 	"metricValue":"-",
							 	 	"metricDescription":"Avg. Drawdown"
						 	 	},
								{
									"metricName":"Max Drawdown",
								 	"metricValue":"-",
							 	 	"metricDescription":"Max Drawdown"
						 	 	},
								{	
									"metricName":"Calmar Ratio",
								 	"metricValue":"-",
							 	 	"metricDescription":"Calmar Ratio"
						 	 	},
								{
									"metricName":"Beta",
								 	"metricValue":"-",
							 	 	"metricDescription":"Beta"
						 	 	},
								{
									"metricName":"Stability",
								 	"metricValue":"-",
							 	 	"metricDescription":"Stability"
						 	 	},
								{
									"metricName":"Avg. Concentration", 
									"metricValue":"-",
								 	"metricDescription":"Avg. Concentration"
							 	},];

				if(this.active) {
					this.reset();
					this.subscribeData();
				} else {
					this.reset();
					this.requestStaticData();
				}	
			},

			_isActiveChanged: function(newVal, oldVal) {
				if((oldVal + 1) && newVal) {
					this.reset();
					this.subscribeData();
				} 
			},

			reset: function() {
				this.netValueData = [];
				this.barData = [];
				this.counter = 0;
			},

			subscribeData: function() {
				this.fire('subscribe-data',{backtestId: this.backtestId});
			},

			onBacktestData: function(e) {
				var isArray = Array.isArray(e.detail);

				if (isArray) {
					this.onBacktestBulkData(e);
					return;
				}

				if (e.detail.outputtype == "performance") {	
					this.addLineData(e.detail);
				}
			},

			onBacktestBulkData: function(e) {
				
				var data = e.detail;

				if(data && data.length > 0) {
					this.addLineBulkData(e.detail);	
				}
			},		

			addLineBulkData: function(data) {
				for(i in data) {
					if (data[i].outputtype=="performance") {
						this.addLineData(data[i]);
					}
				}

				console.log("Bulk End");
			},
		
			addLineData: function(data) {

				var linepoint = {};
            	linepoint.y = data.totalreturn.toFixed(2);
            	//console.log(linepoint.y)
            	linepoint.x = this.counter++; //new Date(e.detail.date);//
           		
           		//console.log("Length: " + this.netValueData.length);

           		var scale = 5*Math.pow(10,Math.floor(Math.log10(Math.abs(linepoint.y))) - 1);

           		this.scale = Math.max(this.scale, scale);

				if (this.cumRetData.length) {	
					this.cumRetData[0]["values"].push(linepoint);
					
						this.minLineData = Math.floor(Math.min(this.minLineData, 0.98*linepoint.y)/this.scale)*this.scale;

						this.maxLineData = Math.ceil(Math.max(this.maxLineData, 1.02*linepoint.y)/this.scale)*this.scale;

					if (this.cumRetData[0]["values"].length % 20 == 0) {
						
						this.$$('#cumRetLineChart')._chart.forceY([this.minLineData,this.maxLineData]);
						this.$$('#cumRetLineChart').refresh();
						this.addMetricData(data);

					}

				} else {
	
					this.cumRetData = [{
					  "key":"Total Return (%)",
					  "color": "#0375b4",
					  "values": [linepoint]}];

					this.minLineData = linepoint.y;
					this.maxLineData = Math.ceil(1.02 * linepoint.y/this.scale)*this.scale;  
					
					this.$$('#cumRetLineChart')._chart.forceY([this.minLineData,this.maxLineData]);
					
					this.$$('#cumRetLineChart')._chart.forceX([0,501]);
					
				}

			},

			addMetricData: function(data) {
				this.metrics = [{
				            		"metricName":"Total Return", 
				            		"metricValue":data.totalreturn.toFixed(2).toString()+'%', 
				            		"metricDescription":"Total Return"
				            	},
								{
									"metricName":"Annual Return",
									"metricValue":data.annualreturn.toFixed(2).toString()+'%',
									"metricDescription":"Annual Return",
								},
							{"metricName":"Volatility", "metricValue":data.annualstandarddeviation.toFixed(2).toString()+'%', "metricDescription":"Volatility"},
							{"metricName":"Sharpe Ratio", "metricValue":data.sharperatio.toFixed(2), "metricDescription":"Sharpe Ratio"},
							{"metricName":"Information Ratio", "metricValue":data.informationratio.toFixed(2), "metricDescription":"Information Ratio"},
							{"metricName":"Sortino Ratio", "metricValue":"2.5", "metricDescription":"Sortino Ratio"},
							{"metricName":"Avg. Drawdown", "metricValue":data.drawdown.toFixed(2).toString()+'%', "metricDescription":"Avg. Drawdown"},
							{"metricName":"Max Drawdown", "metricValue":data.maxdrawdown.toFixed(2).toString()+'%', "metricDescription":"Max Drawdown"},
							{"metricName":"Calmar Ratio", "metricValue":"4.3", "metricDescription":"Calmar Ratio"},
							{"metricName":"Beta", "metricValue":"0.98", "metricDescription":"Beta"},
							{"metricName":"Stability", "metricValue":"0.88", "metricDescription":"Stability"},
							{"metricName":"Avg. Concentration", "metricValue":"0.43", "metricDescription":"Avg. Concentration"},];

			},

			requestStaticData: function() {
				this.$.getBacktestsQuery.generateRequest();
			},

			onGetBacktestSuccess: function(e){
				this.set('backtest', e.detail.response);
				//this.createNetValueChart();
				this.addMetricData(this.backtest.output.analytics.rolling);
				this.createCumRetLineChart();
				this.createMonthlyReturnBarChart();

				//console.log(this.cumRetData);
				//console.log(this.barData);
			},

			createNetValueChart: function() {
				var equityData = this.backtest.output.equity;
				var keys = Object.keys(equityData);
				var linePoints = new Array(keys.length);
				var i = 0;
				
				var min = Infinity; 
				var max = 0;
				keys.sort()
      			.forEach(function(v, i) {
      				linePoints[i++] = {x:v, 
										y:equityData[v]};
          			min = Math.min(equityData[v], min)
          			max = Math.max(equityData[v], max) 
       			});

  				var scale = 5*Math.pow(10,Math.floor(Math.log10(max)) - 2);
		
				min = Math.floor(0.98*min/scale)*scale;

				max = Math.ceil(1.02*max/scale)*scale;

				var yAxisLabel = this.getYAxisLabel(max);
				
	  			this.push('netValueData', {"key":yAxisLabel,
				  				"color": "#0375b4",
					  			"values":linePoints});

	  			
	  			this.$$('#netValueLineChart')._chart
	  			.x(function(d) {return new Date(d.x);});

	  			this.$$('#netValueLineChart')._chart.xAxis
  				.axisLabel('Date')
				.tickFormat(function(d) {return d3.time.format('%d-%m-%Y')(new Date(d)); });

				this.$$('#netValueLineChart')._chart.yAxis
  				//.axisLabel(yAxisLabel)
				.tickFormat(function(d){

					formatMoneyValue = function(number) {

			    		if (number < Math.pow(10,5)) {
					    	return [number,""];
					    } else if (number > Math.pow(10,5) && number < Math.pow(10,7) ) {

					    	number  = number / Math.pow(10,5); 
					    	var plural = Math.round(number) > 1 ;
					    	
					    	return [number.toFixed(2), (plural ? " Lacs":"Lac")]; 
					    } else {
					    	number  = number / Math.pow(10,7); 
					    	var plural = Math.round(number) > 1 ;
					    	return [number.toFixed(2), (plural ? " Crores": " Crore")];
					    }

					};

					formatValue = d3.format(".2f");
					var x = formatMoneyValue(d);
					return formatValue(x[0]);
				});				

				//₨
				this.$$('#netValueLineChart')._chart.forceY([min,max]);
					  			
	  			this.$$('#netValueLineChart').refresh();

			},

			createCumRetLineChart: function() {
				var equityData = this.backtest.output.totalreturn;
				var keys = Object.keys(equityData);
				var linePoints = new Array(keys.length);
				var i = 0;
				
				var min = Infinity; 
				var max = 0;
				keys.sort()
      			.forEach(function(v, i) {
      				linePoints[i++] = {x:v, 
										y:equityData[v]};
          			min = Math.min(equityData[v], min)
          			max = Math.max(equityData[v], max) 
       			}); 

  				var scale = 5*Math.pow(10,Math.floor(Math.log10(Math.abs(max))) - 1);

  				
  				min = Math.floor(0.98*min/scale,-1)*scale;

				max = Math.ceil(1.02*max/scale,-1)*scale;

				
				var yAxisLabel = "Total Return (%)";
				
	  			this.push('cumRetData',{"key":yAxisLabel,
				  					"color": "#0375b4",
					  				"values":linePoints});



	  			this.$$('#cumRetLineChart')._chart
	  			.x(function(d) {return new Date(d.x);});

	  			this.$$('#cumRetLineChart')._chart.xAxis
  				.axisLabel('Date')
				.tickFormat(function(d){

					return d3.time.format('%d-%m-%Y')(new Date(d));
				 });

				this.$$('#cumRetLineChart')._chart.yAxis
				.ticks(10);

				this.$$('#cumRetLineChart')._chart.forceY([min,max]);

				this.$$('#cumRetLineChart').refresh();

				console.log("Cumret Chart: Exit")
			},

			createMonthlyReturnBarChart: function() {
				console.log("Monthly Ret Chart: Enter")
				var aggregatedReturns = this.backtest.output.returns.monthly;
		
				var barPoints = new Array(Object.keys(aggregatedReturns).length);
				var i = 0;

				for (var key in aggregatedReturns) {
					barPoints[i++] = {x:key, y:aggregatedReturns[key]};
				}

				this.push('barData', {"key":"Monthly Returns (%)",
				  				"color": "#0375b4",
					  			"values":barPoints}); 


	  			this.$$('#barChart')._chart.xAxis
  				.axisLabel('Year/Month')
				.tickFormat(function(d) {

					var year = Math.floor(d / 100);
					var month = d % 100;
					var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
];
					return monthNames[month - 1] +" "+year.toString();

				});

	  			this.$$('#barChart').refresh();
			},

			onGetBacktestError: function(e) {
			},

			getYAxisLabel: function(number){
				var x = "Net Value" 
				if (number < Math.pow(10,5)) {
			    	return x;
			    } else if (number > Math.pow(10,5) && number < Math.pow(10,7) ) {

			    	return x + " (Lacs)";
			    } else {
			    	return x +" (Crores)";
			    }

			    return label(max);
		    }

		});
	</script>
			
</dom-module>

