<link rel='import' href='../../../bower_components/highcharts-chart/highcharts-stock.html'>
<link rel='import' href='../../../bower_components/chart-elements/chart-line.html'>
<link rel='import' href='../../../bower_components/chart-elements/chart-bar.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tab.html'>
<link rel='import' href='../../../bower_components/paper-card/paper-card.html'>
<link rel='import' href='../../../bower_components/iron-signals/iron-signals.html'>
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/iron-pages/iron-pages.html'>

<link rel='import' href='./aq-backtest-metric-item.html'>
<link rel='import' href='./aq-check-authentication.html'>

<dom-module id='aq-backtest-detail-item'>
	<style  include="iron-flex iron-flex-alignment iron-positioning">
	</style>
  
	<style> 
		#netValueLineChart {
			--width:100%;
			--height:70%;
		}

		#cumRetLineChart {
			--height:250px;
			width:100%;
			--margin-bottom: 20px;
			margin-left:5px;
			--highcharts-container:{
				width:98%;
			};
		}

		#trackVarLineChart {
			margin-bottom: 20px;
			height:160px;
			width:100%;
			width:98%;
		}

		#barChart {
			height:400px;
			width:100%;
		}

		.detail {
			margin:10px;
			--margin-bottom:0px !important;
			--height:250px;
			width:50%;
		}	

		.detailmetric {
			--border:1px solid teal;
			height:73px;
			--border-bottom:1px solid teal;
			--border-right:1px solid teal;
		}

		.detailmetric span {
			vertical-align: center;
			text-align: center;
			margin-top:15px;
		}

		.mdcontainer {
			margin-left:10px;
			margin-right:10px;
			--margin-top:5px;
			margin-bottom:8px;
			height:62px;
		}

		#detail-header {
			--margin-top:20px;
			--margin-bottom: 20px;
			margin-left:10px;
			font-weight: bold;
		}
	
		#detail-header-bottom {
			margin-top:5px;
			margin-bottom: 15px;
			margin-left:10px;
			font-weight: bold;
		}

		.chart {
			width:95%;
		}

		.tooltip:{
			margin-top: -10px;

		}
		.width_tab{
			width: 144px;
		}
		.wrap    { 
		  -webkit-flex-wrap: wrap;
		  flex-wrap: wrap;
		}  

		.paper_body {
			width: 98%;
		    text-align: -webkit-center;
		    color:#24293d;
		    border:1px solid teal;
		}

		.flex_container{
			display: flex;
			display: -webkit-flex; /* Safari */
            -webkit-flex-wrap: wrap; 
            flex-wrap: wrap;
        }

        .card-actions{
			background-color: #f2fbf7;
        
		}
		
		paper-tabs {
			--paper-tabs-selection-bar-color:teal;

			--paper-tabs:{
				--height:100%;
				margin-bottom:10px;
			};

			margin-right:10px;
		}

	</style>

	<template>

		<iron-ajax
			url=""
			method='GET'
          	id='getTestDataQuery'
          	handle-as="json"
          	on-response="onTestData">
        </iron-ajax>

		<aq-check-authentication id='authItem'></aq-check-authentication>
		
			<paper-card class="flex detail layout vertical paper_body">
				<div id='detail-header' class="layout horizontal">
					<span class="self-center">Equity Curve</span>
					<div class="flex"></div>	
					
					<paper-tabs noink selected="{{graphType}}">
						<paper-tab>Cumulative Return</paper-tab>
						<template is='dom-if' if='[[!active]]'>
							<!--paper-tab>Net Value</paper-tab-->
							<paper-tab>Monthly Returns</paper-tab>
						</template>
					</paper-tabs>
						
				</div>
				
				<iron-pages on-iron-resize='onResize' selected="{{graphType}}">
				
					<highcharts-stock 
			  			id="cumRetLineChart"
			  			type="line"  
			  			y-axis="{{cumRetLineChartOptions.yAxis}}"
			  			tooltip-options="[[cumRetLineChartOptions.tooltip]]"
			  			highchart-options="[[cumRetLineChartOptions.highchartOptions]]"
			  			legend-options="[[cumRetLineChartOptions.legendOptions]]">
			  		</highcharts-stock>

			  		<template is='dom-if' if='[[!active]]'>
					<!--nvd3-line 
			  			id="netValueLineChart" 
			  			height=300
			  			show-legend 
			  			use-interactive-guideline 
			  			auto-resize
			  			no-data="Fetching Data" 
			  			data="[[netValueData]]">
			  		</nvd3-line-->
		  		<!--/template-->

		  		<!--template is='dom-if' if="[[cumRetData]]"-->
					
		  		<!--/template-->
			      
			    <!--template is='dom-if' if="[[barData]]" y-axis="{{barChartOptions.yAxis}}"
	  					 	tooltip-options="[[barChartOptions.tooltip]]"-->   

				  		<highcharts-stock
				  			id="barChart" 
				  			type="column"
				  			y-axis = "[[barChartOptions.yAxis]]"
				  			x-Axis = "[[barChartOptions.xAxis]]"
				  			tooltip-options="[[barChartOptions.tooltip]]"
				  			highchart-options="[[barChartOptions.highchartOptions]]"
				  			>	 	
		  				 </highcharts-stock>
	  				 </template>
		  		<!--/template-->
	
		  		</iron-pages>
			      
			    <div class='card-actions'>  
				<div id='detail-header-bottom' class="layout horizontal flex">
					<span class="self-center">Risk Metrics</span>
					<div class="flex"></div>	
				</div>

				<div class="wrap flex_container">
					<template is="dom-repeat" items="{{metrics}}">
						<div class="layout horizontal flex mdcontainer">
							<aq-backtest-metric-item class="flex width_tab" metric-name={{item.metricName}} 
								metric-value={{item.metricValue}}
								metric-desc={{item.metricDescription}}>
							</aq-backtest-metric-item>
						</div>
					</template>			
				</div>
				</div>
			</paper-card>	

		<iron-signals id='datasignal' on-iron-signal-point-data='onBacktestData' on-iron-signal-bulk-data='onBacktestData'></iron-signals>

		<iron-ajax
          	url="[[computeGetBacktestUrl(backtestId)]]"
     	 	method='GET'
          	id='getBacktestsQuery'
          	handle-as="json"
          	on-response="onGetBacktestSuccess"
          	on-error="onGetBacktestError"
          	headers='{{header}}'
          	debounce-duration="300">
        </iron-ajax>
			
	</template>
	<script>
		Polymer ({
			is:'aq-backtest-detail-item',
			
			properties:{
				hide: {
					type: Boolean,
					value: true,
				},

				active:{
					type:Boolean,
					value:false,
					observer:'_isActiveChanged',
				},

				metrics:Object,

				graphType: {
					type:Number,
					value:0,
				},

				netValueData: {
					type:Object, 
					value:{},
				},

				cumRetLineChartOptions:{
					type:Object,
					value:{
						
			            yAxis: [{
			                labels: {
			                    align: 'right',
			                    x: -3,
			                    formatter: function () {
			                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
			                    }
			                },

			                plotLines: [{
			                    value: 0,
			                    width: 2,
			                    color: 'silver'
			                }],
			               
			                height: '100%',
			                lineWidth: 2
			            }, {
			                labels: {
			                    align: 'right',
			                    x: -3
			                },
			                top: '0%',
			                height: '0%',
			                offset: 0,
			                lineWidth: 2
			            }],

			          	tooltip: {
				            xDateFormat:'%e-%b %Y',
				            shared:true,
				        },

				         /*tooltip: {
				            backgroundColor: 'white',
				            borderWidth: 0,
				            borderRadius: 0,
				            headerFormat: '{point.key} ',
				            pointFormat: ' | <span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b>',
				            positioner: function () {
				                return { x: 5, y: 25 };
				            },
				            shadow: false
				        },*/

				        highchartOptions:{
				        	rangeSelector: {
				        		enabled: false,
				        	},

				        	title:{
								text:"Strategy vs Benchmark Performance",
								margin:30
							},
			          	}, 

			          	legendOptions:{
			          		enabled:true,
			          		align:"left",
			          		floating:true,
			          		verticalAlign:'top',
			          		y:15,
			          		itemStyle: {
			          			fontSize:13,
			          			fontWeight:"normal",
			          		},
			          	},

					}
				},

				barChartOptions:{
					type:Object,
					value:{
						
						yAxis:{
							labels: {
			                    formatter: function () {
			                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
			                    }
			                },

			                plotLines: [{
			                    value: 0,
			                    width: 2,
			                    color: 'silver'
			                }],
			            },

			            xAxis:{
			            	type:'datetime',
			            },

			            tooltip: {
				            xDateFormat:'%b \'%y',
				            shared:true,
				        },

				        highchartOptions:{
				        	rangeSelector: {
				        		enabled: false,
				        	},

				        	title: {
								text:"Strategy vs Benchmark Performance"
							},
			          	},  


					},
				},

				trackVarData:{
					type:Object,
					value:{},
				},

				hasTrackVarData:{
					type:Boolean,
					value:false,
				},

				maxLineData:{
					type:Number,
					value:-Infinity,

				},

				minLineData:{
					type:Number,
					value: Infinity,
				},

				counter:{
					type:Number,
					value:0,
				},

				barData: {
					type:Object,
					value:{}, 
				},

				count:{
					type:Number,
					value:0,
				},

				backtestId: {
					type:String,
					observer: '_backtestIdChanged',
				},

				backtest:Object,
				
				scale:{
					type:Number,
					value:1,
				},

				header: Object,

				APIEndPoint:String,

			},

			attached: function() {
				this.listen(this.$$('paper-card'), 'resize', 'onResize');
			},

			computeGetBacktestUrl: function(backtestId) {
				var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
				return APIEndPoint+'/backtest/'+backtestId;
			},

			resetMetrics: function() {
				this.metrics = [{
				            		"metricName":"Total Return", 
				            		"metricValue":"-", 
				            		"metricDescription":"Total Return"
				            	},
								{
									"metricName":"Annual Return",
									"metricValue":"-",
									"metricDescription":"Annual Return",
								},
								{
									"metricName":"Volatility",
								 	"metricValue":"-", 
								 	"metricDescription":"Volatility"
								},
								{
									"metricName":"Sharpe Ratio", 
									"metricValue":"-",
									"metricDescription":"Sharpe Ratio"
								},
								{
									"metricName":"Information Ratio",
									"metricValue":"-",
								 	"metricDescription":"Information Ratio"
								},
								{	
									"metricName":"Sortino Ratio",
									"metricValue":"-",
									"metricDescription":"Sortino Ratio"
								},
								{	
									"metricName":"Avg. Drawdown",
								 	"metricValue":"-",
							 	 	"metricDescription":"Avg. Drawdown"
						 	 	},
								{
									"metricName":"Max Drawdown",
								 	"metricValue":"-",
							 	 	"metricDescription":"Max Drawdown"
						 	 	},
								{	
									"metricName":"Calmar Ratio",
								 	"metricValue":"-",
							 	 	"metricDescription":"Calmar Ratio"
						 	 	},
								{
									"metricName":"Beta",
								 	"metricValue":"-",
							 	 	"metricDescription":"Beta"
						 	 	},
								{
									"metricName":"Stability",
								 	"metricValue":"-",
							 	 	"metricDescription":"Stability"
						 	 	},
								{
									"metricName":"Avg. Concentration", 
									"metricValue":"-",
								 	"metricDescription":"Avg. Concentration"
							 	},];

			},

			_isActiveChanged: function(newVal, oldVal) {
				if((oldVal + 1) && newVal) {
					this.reset();
					this.async(this.subscribeData, 1000);
				} 
			},

			reset: function() {
				this.netValueData = {};
				this.resetMetrics();
				this.counter = 0;
				this.hasTrackVarData = false;
				
				if(this.$$('#cumRetLineChart')) {
					for(i=0;i<7;i++){
						this.$.cumRetLineChart.removeSeries(this.$.cumRetLineChart.getSeries(i).index);
					}
				}

				if(this.$$('#barChart')) {
					for(i=0;i<2;i++){
						this.$$('#barChart').removeSeries(this.$$('#barChart').getSeries(i).index);
					}
				}
			},

			subscribeData: function() {
				this.async(function(){this.fire('subscribe-data',{backtestId: this.backtestId})}, 500);
				
				this.cumRetData = {datasets:
									[{label:"Strategy",
								 		borderColor: "#0375b4",
								 		borderWidth:2,
										fill:false,
										pointRadius:0,
										pointHoverRadius:10,
										tension:0,
										data:[]},
									{label:"Benchmark",
										borderColor:"#cc6666",
										borderWidth:1,
										fill:false,
										pointRadius:0,
										pointHoverRadius:10,
										tension:0,
										data:[]}]};

				this.trackVarData = {datasets:[]};
			},

			initializeTrackVarData: function(data) {
				var colors = ["#6e2667","#fc4a1a","#0375b4","#FFAA1D","#007849"];
				
				this.hasTrackVarData = true;

				//Update chart height for accomodatin tracking variables
				this.set('cumRetLineChartOptions.yAxis',[]);
				this.$.cumRetLineChart._chart.yAxis[0].update({
		                labels: {
		                    align: 'right',
		                    x: -3,
		                    formatter: function () {
		                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
		                    }
		                },
		               
		                height: '60%',
		                lineWidth: 2
		            }),

				this.$.cumRetLineChart._chart.yAxis[1].update({
		                labels: {
		                    align: 'right',
		                    x: -3
		                },
		                top: '65%',
		                height: '35%',
		                offset: 0,
		                lineWidth: 2
		            });


				

				var dataset = new Array(this.realtimeXLabels.length);
				for(var i=0; i<this.realtimeXLabels.length; i++) {
					dataset[i] = [Date.parse(this.realtimeXLabels[i]), NaN];
				}

				var i=0;
				var keysArray = Object.keys(data["variables"]).sort();

				for (i=0;i<keysArray.length; i++) {
					dataset[0][1] = data["variables"][keysArray[i]];
					this.$$('#cumRetLineChart').addSeries(keysArray[i], dataset, false, {lineWidth:1, yAxis:1, color:colors[i]});
				}

			},

			onBacktestData: function(e) {
				var isArray = Array.isArray(e.detail);

				if (isArray) {
					this.onBacktestBulkData(e);
					return;
				}

				if (e.detail.outputtype == "performance") {	
					this.addRealTimeData(e.detail,"");
				} else if(e.detail.outputtype == "labels") {
					this.addRealTimeData(e.detail, "labels");
				}
			},

			onBacktestBulkData: function(e) {
				
				var data = e.detail;
				if(data && data.length > 0) {
					this.addLineBulkData(e.detail);	
				}
			},		

			addLineBulkData: function(data) {
				for(i in data) {
					if (data[i].outputtype=="performance") {
						this.addRealTimeData(data[i],"");
					} else if(data[i].outputtype == "labels") {
						this.addRealTimeData(data[i], "labels");
					}
				}
			},
		
			addRealTimeData: function(data, type) {

				var legends = ["Strategy", "Benchmark"]
				var types = ["totalreturn","totalreturn_benchmark"];
				var colors = ["#cc6666","#0375b4","#FFAA1D","#007849","#6e2667","#fc4a1a"];

				if (type=="labels") {
					this.realtimeXLabels = Object.keys(data.labels).sort();

					var dataset = new Array(this.realtimeXLabels.length);
					this.rtData = [dataset, dataset];
					for(var i=0; i<this.realtimeXLabels.length; i++) {
						dataset[i] = [Date.parse(this.realtimeXLabels[i]), NaN];
					}

					this.$$('#cumRetLineChart').addSeries("Strategy", this.rtData[0], false, {color:colors[1],lineWidth:2});
					this.$$('#cumRetLineChart').addSeries("Benchmark", this.rtData[1], false, {color:colors[0],lineWidth:1});
					return;
				}

				var ct = this.counter++;
				
				/*for (idx = 0;idx<10;idx++) {
					this.$$('#cumRetLineChart').removeSeries(idx);
				}*/

				for (idx=0;idx<types.length;idx++) {
	            	
					this.rtData[idx][ct][1] = data[types[idx]];
					this.$$('#cumRetLineChart')._chart.series[idx].data[ct].update(data[types[idx]]);
					this.$$('#cumRetLineChart')._chart.redraw();
            	}

        		this.addMetricData(data);
           
            	/*if(this.cumRetData.datasets[0]) {
	            	var nPoints = this.cumRetData.datasets[0].data.length;
	            	if (nPoints > 0 && (nPoints % 1 == 0)) {
	            		
	            		//this.$$('#cumRetLineChart').updateChart();
	            	}
	            }*/

				if (data["variables"]) {
					
					// Add variable tracker data
					if(this.hasTrackVarData) {
						
						
						var keysArray = Object.keys(data["variables"]).sort();

						for (i=0; i<keysArray.length; i++) {
							this.$$('#cumRetLineChart')._chart.series[i+2].data[ct].update(data["variables"][keysArray[i]]);
							this.$$('#cumRetLineChart')._chart.redraw();
						}
						
					} else {
						this.initializeTrackVarData(data);
					}

					if(this.trackVarData.datasets[0] && this.$$('#trackVarLineChart')) {
						var nPoints = this.trackVarData.datasets[0].data.length;
						if(nPoints > 0 && (nPoints % 1 == 0)) {
							this.$$('#trackVarLineChart').updateChart();
						}
					}
				}
			},

			addMetricData: function(data) {
				this.metrics = [{
				            		"metricName":"Total Return", 
				            		"metricValue":data.totalreturn.toString()+'%', 
				            		"metricDescription":"Total Return"
				            	},
								{
									"metricName":"Annual Return",
									"metricValue":data.annualreturn.toString()+'%',
									"metricDescription":"Annual Return",
								},
							{"metricName":"Volatility", "metricValue":data.annualstandarddeviation.toString()+'%', "metricDescription":"Volatility"},
							{"metricName":"Sharpe Ratio", "metricValue":data.sharperatio, "metricDescription":"Sharpe Ratio"},
							{"metricName":"Information Ratio", "metricValue":data.informationratio, "metricDescription":"Information Ratio"},
							//{"metricName":"Sortino Ratio", "metricValue":"2.5", "metricDescription":"Sortino Ratio"},
							//{"metricName":"Avg. Drawdown", "metricValue":data.drawdown.toFixed(2).toString()+'%', "metricDescription":"Avg. Drawdown"},
							{"metricName":"Max Drawdown", "metricValue":data.maxdrawdown.toString()+'%', "metricDescription":"Max Drawdown"},
							{"metricName":"Calmar Ratio", "metricValue":data.calmarratio, "metricDescription":"Calmar Ratio"},
							{"metricName":"Beta", "metricValue":data.beta, "metricDescription":"Beta"},
							{"metricName":"Stability", "metricValue":data.stability, "metricDescription":"Stability"},
							{"metricName":"Alpha", "metricValue":data.alpha.toString()+'%', "metricDescription":"Alpha"},
							//{"metricName":"Avg. Concentration", "metricValue":"0.43", "metricDescription":"Avg. Concentration"},
							];

			},

			requestStaticData: function() {
				if(this.backtestId && this.$.authItem.checkHasToken()) {
					this.header = this.$.authItem.getHeader();
					this.$.getBacktestsQuery.generateRequest();
				}
			},

			onGetBacktestSuccess: function(e){
				this.set('backtest', e.detail.response);
				
				if(this.backtest.output.analytics.rolling) {
					this.addMetricData(this.backtest.output.analytics.rolling);
				}

				this.async(this.createCumRetLineChart, 500);
				this.async(this.createMonthlyReturnBarChart, 2000);
				
				if(this.backtest.output.variables) {
					// this variable is used because array changes are somehow not relaying back the template
					this.hasTrackVarData = true;
					this.set('cumRetLineChartOptions.yAxis',[]);
					this.$.cumRetLineChart._chart.yAxis[0].update({
			                labels: {
			                    align: 'right',
			                    x: -3,
			                    formatter: function () {
			                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
			                    }
			                },
			               
			                height: '60%',
			                lineWidth: 2
			            }),

					this.$.cumRetLineChart._chart.yAxis[1].update({
			                labels: {
			                    align: 'right',
			                    x: -3
			                },
			                top: '65%',
			                height: '35%',
			                offset: 0,
			                lineWidth: 2
			            });

					this.async(this.createTrackVarLineChart, 500);
				} 
			},

			createNetValueChart: function() {
				var equityData = this.backtest.output.equity;
				var keys = Object.keys(equityData);
				var linePoints = new Array(keys.length);
				var i = 0;
				
				var min = Infinity; 
				var max = 0;
				keys.sort()
      			.forEach(function(v, i) {
      				linePoints[i++] = {x:v, 
										y:equityData[v]};
          			min = Math.min(equityData[v], min)
          			max = Math.max(equityData[v], max) 
       			});

  				var scale = 5*Math.pow(10,Math.floor(Math.log10(max)) - 2);
		
				min = Math.floor(0.98*min/scale)*scale;

				max = Math.ceil(1.02*max/scale)*scale;

				var yAxisLabel = this.getYAxisLabel(max);
				
	  			this.push('netValueData', {"key":yAxisLabel,
				  				"color": "#cc6666",
					  			"values":linePoints});

	  			
	  			this.$$('#netValueLineChart')._chart
	  			.x(function(d) {return new Date(d.x);});

	  			this.$$('#netValueLineChart')._chart.xAxis
  				.axisLabel('Date')
				.tickFormat(function(d) {return d3.time.format('%d-%m-%Y')(new Date(d)); });

				this.$$('#netValueLineChart')._chart.yAxis
  				//.axisLabel(yAxisLabel)
				.tickFormat(function(d){

					formatMoneyValue = function(number) {

			    		if (number < Math.pow(10,5)) {
					    	return [number,""];
					    } else if (number > Math.pow(10,5) && number < Math.pow(10,7) ) {

					    	number  = number / Math.pow(10,5); 
					    	var plural = Math.round(number) > 1 ;
					    	
					    	return [number.toFixed(2), (plural ? " Lacs":"Lac")]; 
					    } else {
					    	number  = number / Math.pow(10,7); 
					    	var plural = Math.round(number) > 1 ;
					    	return [number.toFixed(2), (plural ? " Crores": " Crore")];
					    }

					};

					formatValue = d3.format(".2f");
					var x = formatMoneyValue(d);
					return formatValue(x[0]);
				});				

				//₨
				this.$$('#netValueLineChart')._chart.forceY([min,max]);
				
			},

			createCumRetLineChart: function() {
				
				var colors = ["#0375b4","#cc6666","#FFAA1D","#007849","#6e2667","#fc4a1a"];
				var types = ["algorithm","benchmark"];
				var legend = ["Strategy (%)", "Benchmark (%)"];
				var width = [2, 1];

				for (index=0;index<types.length;index++) {
					
					var equityData = this.backtest.output.totalreturn[types[index]];
					var keys = Object.keys(equityData);
					var dataset = new Array(keys.length);
			
					var i = 0;
					
					keys.sort()
	      			.forEach(function(v, i) {
	      				dataset[i] = [Date.parse(v), equityData[v]];
	       			}); 

					this.$.cumRetLineChart.addSeries(legend[index], dataset, false, {lineWidth:width[index], color:colors[index]});
		  		}
			},

			createMonthlyReturnBarChart: function() {
				
				var colors = ["#0375b4", "#cc6666", "#FFAA1D","#007849","#6e2667","#fc4a1a"];
				var types = ["algorithm","benchmark"];
				var legend = ["Strategy", "Benchmark"];
				
				//this.barData = {datasets:[]};
				
				for (index=0; index<types.length;index++) {

					var aggregatedReturns = this.backtest.output.returns.monthly[types[index]];
					var keys = Object.keys(aggregatedReturns);
					var dataset = new Array(keys.length);

					var i = 0;
					keys.sort()
	      			.forEach(function(v, i) {
	      				dataset[i] = [Date.parse(v.substring(0, 4)+"-"+v.substring(4, 6)), aggregatedReturns[v]];
	       			}); 

		  			this.$$('#barChart').addSeries(legend[index], dataset, false, {color:colors[index]});	
				}

			},

			createTrackVarLineChart: function() {
				var colors = ["#6e2667","#fc4a1a","#0375b4","#FFAA1D","#007849"];
				var variablesData = this.backtest.output.variables

				if (variablesData) {

					var dates = Object.keys(variablesData).sort();
					var dataArrays = {};
					
					for(idx=0;idx<dates.length;idx++) {
						
						var datekey = dates[idx];
	      				var trackedVars = variablesData[datekey];
	      				var nTrackedVars = Object.keys(trackedVars).length;

	      				for (var key in trackedVars) {
	      					if (dataArrays[key]) {
	      						dataArrays[key].push([Date.parse(datekey), trackedVars[key]]);
	      					} else {
	      						dataArrays[key] = [[Date.parse(datekey), trackedVars[key]]];
	      					}
	      				}
      				}

      				var i=0;
      				for (var key in dataArrays) {
      					this.$.cumRetLineChart.addSeries(key, dataArrays[key], false, {color:colors[i++], lineWidth:1, yAxis:1});
      				}

				}
			},

			onGetBacktestError: function(e) {
			},

			getYAxisLabel: function(number){
				var x = "Net Value" 
				if (number < Math.pow(10,5)) {
			    	return x;
			    } else if (number > Math.pow(10,5) && number < Math.pow(10,7) ) {

			    	return x + " (Lacs)";
			    } else {
			    	return x +" (Crores)";
			    }

			    return label(max);
		    },

		    _backtestIdChanged: function(nId, oId) {
		    	if(nId) {
		    		if(this.active) {
						this.reset();
						this.subscribeData();
					} else {
						this.reset();
						//this.getTestData();
						this.requestStaticData();
					}	
		    	}
		    },

		    onResize: function() {
		    	this.$$('#cumRetLineChart').resizeChart();
		    	
		    	if(this.$$('#barChart')) {
		    		this.$$('#barChart').resizeChart();
		    	}
		    },


		});
	</script>
			
</dom-module>

