<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../aq-markdown-editor.html">

<dom-module id="aq-community-postdetail-reply">

   <style is="custom-style" include="iron-flex iron-positioning">
   </style>
   
  <style>

    #attachButton {
        margin-bottom: -40px;
        margin-right:5px;
    }

    #attachButton paper-button {
        border:none !important;
    }

    paper-button {
        border: 1px solid #333a56;
        height:30px;
        font-size: 13px;
    }

    #buttons{
        margin-bottom: 10px;
    }


  </style>

  <template>
      <div id='attachButton' class="layout horizontal flex">
          <div class="flex"></div>
          <paper-button class="self-end" raised noink on-tap='attachSelected'>Attach<iron-icon icon="editor:attach-file"></iron-icon></paper-button>
      </div>
        
      <div id="replybox" class="flex layout vertical">
        <aq-markdown-editor id="editor" placeholder="Write a reply"></aq-markdown-editor>
        <div class="layout horizontal" id='buttons'>
          <div class="flex"></div>
          <paper-button raised noink>Preview</paper-button>
          <paper-button raised noink on-tap="postThread">Reply</paper-button>
        </div>
      </div>
      
      <iron-ajax 
          url="http://localhost:3002/api/v2/thread/{{threadid}}" 
          body="{{threadData}}" 
          method='POST' 
          id='postThreadQuery' 
          headers='{{header}}' 
          handle-as="json" 
          on-response="onPostReplyResponse"
          on-error="onPostReplyError" 
          last-response="{{ajaxResponse}}" 
          debounce-duration="300">
      </iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'aq-community-postdetail-reply',

      ready: function() {
          var x = localStorage.getItem('my-app-storage');
          var user = JSON.parse(x).user;
          if (user.token) {
            this.header = {
              "aimsquant-token": user.token,
              "Content-Type": "application/json"};  
          }        
      },

      postThread: function() {

          if (!this.header) {
            this.router.go('user/signin',{lastRequest:('/dashboard/community/topics/[[threadid]]')});
            return;
          }
          
          const markdownText = this.$.editor.getContent();
          
          if (markdownText.length>0) {
            this.threadData = {
                "markdownText": markdownText
            };
            this.$.postThreadQuery.generateRequest();
          }
      },

      onPostThreadResponse: function(e) {
        var replies = e.detail.response.replies;
        if (replies.length > 0) {
          this.fire('reply-added',{reply:replies[replies.length - 1]});  
        }      
      },

      onPostReplyError: function(e) {
        console.log(e);
      },

      clearEditor() {
        this.$.editor.setContent("");
      },

    });
  </script>
</dom-module>
