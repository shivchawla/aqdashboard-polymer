<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>

<link rel="import" href="./aq-community-postdetail-content.html">
<link rel="import" href="../profile-img.html">
<link rel='import' href='../../icons/aq-iconset.html'>

<dom-module id="aq-community-postdetail-header">
   
    <style  include="iron-flex iron-flex-alignment iron-positioning">
    </style>

   <style>
    :host {
      display:block;
    }

    #heading {
      border-bottom: 1px solid teal;
      font-size: 30px;
    }

    #heading span {
      color:#cf6766;--#c3403f;
    }

    #category {
     font-size: 15px;
     margin-top:5px;
     color:teal;
    }

    #author {
      margin-top:40px;
      --margin-bottom: 15px;
      border-bottom: 1px solid;
    }

    #img {
      margin-right:10px;
      margin-bottom: 5px;
    }

    #author-desc {
      margin-bottom: 5px;
    }

    paper-icon-button {
      --padding: 0px;
      height:35px;
      width:35px;
      margin-right: 15px;
      margin-top:5px;
      outline: 1px solid; 
      color: #cf6766; --white;
      background-color: white; 
      outline:1px solid teal;
    }


    #header-content {
      margin-top: 30px;
    }

    #followers {
      font-size:15px;
      font-style: italic;
      color: #cf6766;
      margin-right:10px;
    }

    paper-tooltip.iconTooltip {
          --paper-tooltip: {
              font-size: 13px;
              min-width: 40px;
              text-align: center;
          }

          --paper-tooltip-opacity: 1.0;
      --paper-tooltip-background: teal;
    }



  </style>
  <template>

    <div id='post-header'>
      <div id='heading'>
        <span>[[postHeader.title]]</span>
      </div>

      <div class="layout horizontal">
        <span id='category' class="self-top"><i>[[postHeader.category]]</i></span>
        <div class="flex"></div>

        <template is="dom-if" if="[[hasFollowers(followers)]]">
          <span id='followers' class="self-end">[[followers.length]] Followers</span>
        </template>
        <paper-icon-button  id='followIcon' disabled="[[preview]]" toggles=1 icon="vaadin-icons:megafone" on-tap='onFollow'></paper-icon-button>
      </div>

      <aq-community-postdetail-content post-content="[[postHeader]]"></aq-community-postdetail-content> 

    </div>

    <paper-tooltip for='followIcon' offset="2" class=' self-center iconTooltip' position="bottom" animation-delay="0" fit-to-visible-bounds>[[computeFollowTitle(followers)]]</paper-tooltip>
      

    <iron-ajax
      url="http://localhost:3002/api/v2/thread/[[postHeader._id]]/follow"
      method="POST"
      id='follows'
      handle-as="json"
      on-response="onFollowThreadResponse"
      headers='{{header}}'

      debounce-duration="300">
    </iron-ajax>

  </template>

  <script>
    Polymer ({
      is: 'aq-community-postdetail-header',

      properties :{
        postHeader: Object,
        
        header:Object,
        
        preview:{
          type:Boolean,
          value:false,
        },

        followers:{
          type:Array,
          value:[],
        }
      },

      attached: function() {
        if (this.postHeader.followers) {
          this.followers = this.postHeader.followers;
        }
      },

      ready: function() {
          var x = localStorage.getItem('my-app-storage');
          var user = JSON.parse(x).user;
          if (user.token) {
            this.header = {
              "aimsquant-token": user.token,
              "Content-Type": "application/json"};  
          }
      },

      onFollow: function() {
        if(!this.header) {
          this.router.go('/user/signin', {lastRequest:('/dashboard/community/topics/[[postHeader._id]]')});
          return;
        }
        
        this.$.follows.generateRequest();
      },

      hasFollowers: function(followers) {
        return followers.length > 0;
      },

      onFollowThreadResponse: function(e) {
        this.followers = e.detail.response.followers;
      },

      computeFollowTitle: function(followers){
        var x = localStorage.getItem('my-app-storage');
        var userId = JSON.parse(x).user._id;

        if (followers.indexOf(userId) > -1){
          // Change the icon color too
          this.$.followIcon.style.color = 'white';
          this.$.followIcon.style.backgroundColor = '#cf6766';
          this.$.followIcon.style.outlineColor = '#cf6766';
          return "UnFollow";
          //this.$.followIcon

        }

        this.$.followIcon.style.color = '#cf6766';
        this.$.followIcon.style.backgroundColor = 'white';

        return "Follow";

      },

    });

  </script>

</dom-module>
