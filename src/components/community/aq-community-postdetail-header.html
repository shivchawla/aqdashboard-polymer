<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>

<link rel="import" href="./aq-community-postdetail-content.html">
<link rel="import" href="../profile-img.html">
<link rel='import' href='../../icons/aq-iconset.html'>

<dom-module id="aq-community-postdetail-header">
   
    <style  include="iron-flex iron-flex-alignment iron-positioning">
    </style>

   <style>
    :host {
      display:block;
    }

    #heading {
      border-bottom: 1px solid teal;
      font-size: 30px;
    }

    #heading span {
      color:#cc6666;;--#cc6666;
    }

    #category {
     font-size: 15px;
     margin-top:5px;
     color:teal;
    }

    #author {
      margin-top:40px;
      --margin-bottom: 15px;
      border-bottom: 1px solid;
    }

    #img {
      margin-right:10px;
      margin-bottom: 5px;
    }

    #author-desc {
      margin-bottom: 5px;
    }

    paper-icon-button {
      --padding: 0px;
      height:35px;
      width:35px;
      margin-right: 15px;
      margin-top:5px;
      outline: 1px solid; 
      color: #cc6666;; --white;
      background-color: white; 
      outline:1px solid teal;
    }


    #header-content {
      margin-top: 30px;
    }

    #followers {
      font-size:15px;
      font-style: italic;
      color: #cc6666;;
      margin-right:10px;
    }

    paper-tooltip.iconTooltip {
        --paper-tooltip: {
            font-size: 13px;
            min-width: 40px;
            text-align: center;
        }

      --paper-tooltip-opacity: 1.0;
      --paper-tooltip-background: teal;
    }

    #followIcon {
      color: "#cc6666";
      background-color: white;
    }

  </style>

  <template>
    <aq-check-authentication id='authItem'></aq-check-authentication>
    
    <iron-ajax
      url=""
      method="POST"
      id='follows'
      handle-as="json"
      on-response="onFollowThreadResponse"
      headers='{{header}}'
      debounce-duration="300">
    </iron-ajax>

          <div id='post-header'>
            <div id='heading'>
              <span>[[postHeader.title]]</span>
            </div>

            <div class="layout horizontal">
              <span id='category' class="self-top"><i>[[postHeader.category]]</i></span>
              <div class="flex"></div>

              <template is="dom-if" if="[[hasFollowers(followers)]]">
                <span id='followers' class="self-end">[[followers.length]] Followers</span>
              </template>
              <paper-icon-button id='followIcon' disabled="[[preview]]" toggles=1 icon="vaadin-icons:megafone" on-tap='onFollow'></paper-icon-button>
            </div>

            <aq-community-postdetail-content post-content="[[postHeader]]"></aq-community-postdetail-content> 

          </div>

          <paper-tooltip for='followIcon' offset="2" class=' self-center iconTooltip' position="bottom" animation-delay="0" fit-to-visible-bounds>[[computeFollowTitle(followers)]]</paper-tooltip>
  
  </template>

  <script>
    Polymer ({
      is: 'aq-community-postdetail-header',

      properties :{
        postHeader: {
          type:Object,
          observer:'_postHeaderChanged',
        },
        
        header:Object,
        
        preview:{
          type:Boolean,
          value:false,
        },

        followers:{
          type:Array,
          value:[],
        },
      },

      hasPostHeader: function(postHeader) {
          if (postHeader) {
              if (postHeader.followers) {
                this.followers = this.postHeader.followers;
              }
             return Object.keys(postHeader).length > 0;
          }

          return false;
      },

      _postHeaderChanged: function(nPh, oPh) {
        if(nPh) {
          if (nPh.followers) {
              this.followers = nPh.followers;
          }
        }
      },

      computeFollowPostUrl: function(postHeader) {
        var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
        return APIEndPoint+'/thread/'+ postHeader._id+'/follow';
      },

      onFollow: function() {
        if(this.$.authItem.checkHasToken()) {
            this.header = this.$.authItem.getHeader();
            this.$.follows.url = this.computeFollowPostUrl(this.postHeader);
            this.$.follows.generateRequest();
        } else {
            this.fire('rt-changed', {route:'/user/signin'});
        }
      },

      hasFollowers: function(followers) {
        return followers.length > 0;
      },

      onFollowThreadResponse: function(e) {
          this.followers = e.detail.response;
      },

      computeFollowTitle: function(followers){
          if(this.$.authItem.checkHasToken()) {
              var user = this.$.authItem.getUser(); 
             
              var userId = user._id;

              if (followers.indexOf(userId) > -1){
                // Change the icon color too
                this.$$('#followIcon').style.color = 'white';
                this.$$('#followIcon').style.backgroundColor = '#cc6666';
                this.$$('#followIcon').style.outlineColor = '#cc6666';
                return "UnFollow";

              } else {
                  this.$$('#followIcon').style.color = '#cc6666';
                  this.$$('#followIcon').style.backgroundColor = 'white';
                  return "Follow";
              }

          }

      },

    });

  </script>

</dom-module>
