<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>

<link rel="import" href="./aq-community-postdetail-content.html">
<link rel="import" href="../profile-img.html">
<link rel='import' href='../../icons/aq-iconset.html'>
<link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
<link rel="import" href="../common/aq-profile-pic-element.html">
<dom-module id="aq-community-postdetail-header">

    <style include="iron-flex iron-flex-alignment iron-positioning">
    </style>

    <style>
        :host {
            display: block;
            font-family: 'Lato', sans-serif;
        }

        .container {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            padding: 10px 20px;
            border-radius: 4px;
        }

        #heading {
            /*border-bottom: 1px solid teal;*/
            font-size: 1.2em;
            font-weight: 700;
            color: #4e4e4e;
        }

        #category {
            font-size: 0.8em;
            margin-top: 5px;
            color: #cc6666;
        }

        #author {
            margin-top: 40px;
            --margin-bottom: 15px;
            /*border-bottom: 1px solid;*/
        }

        #img {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        #author-desc {
            margin-bottom: 5px;
        }

        #header-content {
            margin-top: 30px;
        }

        #followers {
            font-size: 0.8em;
            color: #a7a7a7;
            margin-right: 10px;
        }

        paper-tooltip.iconTooltip {
            --paper-tooltip: {
                font-size: 13px;
                min-width: 40px;
                text-align: center;
            } --paper-tooltip-opacity: 1.0;
            --paper-tooltip-background: teal;
        }
        .middle-container{
            position: relative;
        }
        .right-container{
            position: absolute;
            top:-20px;
            right:0;
        }
        #followIcon{
            font-size: 0.7em;
            --paper-button-color:#7c7c7c;
            background: #f5f5f5;
            padding: 0 20px;
            border-radius: 0;
            height: 25px;
            top:-2px;
        }
        paper-button{
            border:none;
        }
        aq-community-postdetail-content{
            position: relative;
            top:20px;
        }
        #post-header{
            background-color: #fff;
        }
        aq-community-postdetail-content{
            --aq-community-postdetail-content-background-color:#fafafb;
        }
    </style>

    <template>
        <aq-check-authentication id='authItem'></aq-check-authentication>

        <iron-ajax
                url=""
                method="POST"
                id='follows'
                handle-as="json"
                on-response="onFollowThreadResponse"
                headers='{{header}}'
                debounce-duration="300">
        </iron-ajax>

        <div id='post-header' class="container">
            <div id='heading'>
                <span>[[postHeader.title]]</span>
            </div>

            <div class="layout horizontal middle-container self-center">
                <span id='category' class="self-top"><i>[[postHeader.category]]</i></span>
                <!--<div class="flex"></div>-->
                <div class="right-container">
                    <template is="dom-if" if="[[hasFollowers(followers)]]">
                        <span id='followers' class="self-end">Following: [[followers.length]]</span>
                    </template>
                    <paper-button id='followIcon' disabled="[[preview]]"
                                       on-tap='onFollow'>Follow</paper-button>
                </div>
            </div>

            <aq-community-postdetail-content post-content="[[postHeader]]"></aq-community-postdetail-content>

        </div>

    </template>

    <script>
        Polymer({
            is: 'aq-community-postdetail-header',

            properties: {
                postHeader: {
                  type: Object,
                  observer:'_postHeaderChanged',
                },

                header: Object,

                preview: {
                    type: Boolean,
                    value: false,
                },

                followers: {
                    type: Array,
                    value: [],
                },
            },

            _postHeaderChanged: function () {

                if (this.postHeader.followers) {
                    this.followers = this.postHeader.followers;
                }
            },

            hasPostHeader: function (postHeader) {
                if (postHeader) {
                    return Object.keys(postHeader).length > 0;
                }

                return false;
            },

            computeFollowPostUrl: function (postHeader) {
                var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                return APIEndPoint + '/thread/' + postHeader._id + '/follow';
            },

            onFollow: function () {
                if (this.$.authItem.checkHasToken()) {
                    this.header = this.$.authItem.getHeader();
                    this.$.follows.url = this.computeFollowPostUrl(this.postHeader);
                    this.$.follows.generateRequest();
                } else {
                    this.fire('rt-changed', {route: '/user/signin'});
                }
            },

            hasFollowers: function (followers) {
                return followers.length > 0;
            },

            onFollowThreadResponse: function (e) {
                this.followers = e.detail.response;
            },

            computeFollowTitle: function (followers) {
                if (this.$.authItem.checkHasToken()) {
                    var user = this.$.authItem.getUser();

                    var userId = user._id;

                    if (followers.indexOf(userId) > -1) {
                        // Change the icon color too
                        this.$$('#followIcon').style.color = 'white';
                        this.$$('#followIcon').style.backgroundColor = '#cc6666';
                        this.$$('#followIcon').style.outlineColor = '#cc6666';
                        return "UnFollow";
                        //this.$.followIcon

                    }

                    this.$$('#followIcon').style.color = '#cc6666';
                    this.$$('#followIcon').style.backgroundColor = 'white';

                    return "Follow";
                }

            },

        });

    </script>

</dom-module>
