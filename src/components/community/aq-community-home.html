<link rel='import' href='../../../bower_components/paper-fab/paper-fab.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tab.html'>
<link rel="import" href="../../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>
<link rel='import' href='../../../bower_components/paper-tooltip/paper-tooltip.html'>
<link rel='import' href='../../../bower_components/app-route/app-route.html'>
<link rel='import' href='../../../bower_components/app-route/app-location.html'>

<link rel='import' href='../common/aq-check-authentication.html'>
<link rel="import" href="./aq-community-home-searchbar.html">
<link rel="import" href="./aq-community-home-post-item2.html">
<link rel='import' href='../common/aq-pagination.html'>
<link rel="import" href="../common/aq-loading-progress.html">
<link rel="import" href="../common/announcement-card.html">
<link rel='import' href='../../icons/aq-iconset.html'>
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<dom-module id="aq-community-home">

    <style include="iron-flex iron-flex-alignment iron-positioning">
    </style>

    <style>

        p {
            font-size: 28px;
            margin-bottom: 0px;
        }

        #header {
            margin-bottom: 30px;
        }

        i {
            font-size: 16px;
        }

        .insidetoolbar {
            outline-color: blue;
            border: solid;
        }

        input {
            font: inherit;
            font-size: 16px;
            color: black;
        }

        #container {
            margin: 0 auto;
            margin-top: 20px;
            color: #24293d;
            width: 95%;
            margin-left: 2%;

            --overflow-y: scroll;
            --height: 100%;
        }

        #fab {
            background: teal;
            -- #24293d;
            --float: right;
            position: fixed;
            right: 25px;
            bottom: 30px;
        }

        paper-tab:hover {
            font-weight: bold;
            font-size: 18px;
        }

        #community-tabs {
            max-width: 350px;
            font-size: 16px;
            margin: 0 auto;
            border-bottom: 1px solid #e5e5e5;
            --paper-tabs-selection-bar-color: teal;
        !important;
            margin-bottom: -10px;
        }

        #ifsearch {
            display: none;
        }

        paper-tab.iron-selected {
            color: #000;
        }

        paper-tooltip.iconTooltip {
            --paper-tooltip: {
                font-size: 13px;
                min-width: 40px;
                text-align: center;
            } --paper-tooltip-opacity: 1.0;
            --paper-tooltip-background: teal;
        }

        aq-community-home-post-item2 {
            width: 100%;
            margin: 0 auto;
        }



        announcement-card {
            --announcement-card-width: 300px;
            margin-bottom: 30px;
        }

        .main-container {
            position: relative;
            top: 30px;
        }

        .list-container {
            margin-right: 60px;
            width: 100%;
        }

        ul {
            list-style: none;
        }

        .announcement-container {
            position: relative;
            top: 18px;
        }

        .flex {
            width: 20%;
        }

        #searchbox, #searchbox1 {
            height: 32px;
            -webkit-appearance: none;
            line-height: 46px;
            border: 0;
            margin: 0;
            padding-left: 30px;
            border: 1px solid #e5e5e5;
            @apply(--paper-font-body1);
            font-size: 14px;
            background-color: #fff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease-in-out;
            display: inline-block;
        }

        #searchbox:focus, #searchbox1:focus {
            outline: 0;
            background-color: #f7f7f7;
        }

        #searchbox::-webkit-search-cancel-button, #searchbox1::-webkit-search-cancel-button {
            position: relative;
            right: 15px;
        }

        .search-bar {
            width: 45%;
            margin: 0 auto;
            /*display: flex;*/
            /*align-items: center;*/
            position: relative;
        }

        paper-button {
            border: none;
        }

        .upper-container {
            margin-bottom: 20px;
        }

        .search-btn {
            border: none;
            font-size: 13px;
            background-color: teal;
            color: #fff;
            padding: 0 20px;
            border-radius: 2px;
            height: 35px;
        }
    </style>
    <template>

        <aq-check-authentication id='authItem'></aq-check-authentication>

        <iron-ajax
                url=""
                method='GET'
                id='getAllThreadsQuery'
                params='[[searchParam]]'
                handle-as="json"
                on-response="onGetAllThreadsResponse"
                on-error="onGetAllThreadsError"
                headers='{{header}}'
                debounce-duration="300"
                loading='{{loading}}'>
        </iron-ajax>

        <iron-signals on-iron-signal-post-added='onPostAdded'></iron-signals>

        <iron-signals on-iron-signal-dirtybit='onSetDirtyBit'></iron-signals>

        <aq-loading-progress loading='{{loading}}'></aq-loading-progress>

        <div id='container' class="layout vertical flex">
            <div class="upper-container layout horizontal wrap">
                <div class="search-bar layout horizontal center-justified">
                    <input id="searchbox" placeholder="Search Term" class="flex"
                           value="{{searchText::change}}"
                           on-keydown="checkForKeys" on-blur='blur'>
                </div>
                <div class="search-bar layout horizontal center-justified">
                    <input id="searchbox1" placeholder="Tags" class="flex"
                           value="{{searchText::change}}"
                           on-keydown="checkForKeys" on-blur='blur'>
                </div>
                <paper-button raised class="btn search-btn" on-tap="search">Search</paper-button>
            </div>
            <!--<div class="layout horizontal wrap">-->
            <!--<div id="header">-->
            <!--<p> AimsQuant Community</p>-->
            <!--<i style="margin-bottom:50px; color:teal;">Share, Learn and Code</i>-->
            <!--</div>-->

            <!--<div class="flex"></div>-->

            <!--<aq-community-home-searchbar id='searchbar'-->
            <!--class="self-end"-->
            <!--active="[[isSearchActive(searchText)]]"-->
            <!--search-value="[[searchText]]">-->
            <!--</aq-community-home-searchbar>-->

            <!--</div>-->

            <template is='dom-if' if='[[isSearchActive(searchText, searchCategory)]]'>
                <p style="font-size: 16px;"><i>Search results for "[[searchText]]"&nbsp</i> in Category: <i>"[[searchCategory]]"</i>
                </p>
            </template>

            <paper-tabs on-iron-select="onActivateTab" id="community-tabs" selected="{{selected}}" noink>
                <paper-tab id="popular">Popular</paper-tab>
                <paper-tab id="newest">Newest</paper-tab>
                <paper-tab id="following">Following</paper-tab>
                <paper-tab id="personal">Personal</paper-tab>
            </paper-tabs>
            <div class="main-container layout horizontal">
                <ul class="list-container layout vertical">
                    <template is="dom-repeat" items="{{threads}}">
                        <li>
                            <aq-community-home-post-item2 thread="[[item]]">
                            </aq-community-home-post-item2>
                        </li>
                    </template>
                </ul>
                <div class="announcement-container layout vertical">
                    <announcement-card header="Important Announcement"
                                       sub-header="This is a very important announcement">
                    <span>
                        It is a long established fact that a reader will be distracted by the readable content of a page when
                        looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution
                        of letters, as opposed to using 'Content here, content here', making it look like readable English. Many
                        desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a
                        search for 'lorem ipsum' will uncover many web sites still in their infancy. Various versions have
                        evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                    </span>
                    </announcement-card>

                    <announcement-card header="Important Announcement"
                                       sub-header="This is a very important announcement">
                    <span>
                        It is a long established fact that a reader will be distracted by the readable content of a page when
                        looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution
                        of letters, as opposed to using 'Content here, content here', making it look like readable English. Many
                        desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a
                        search for 'lorem ipsum' will uncover many web sites still in their infancy. Various versions have
                        evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                    </span>
                    </announcement-card>
                </div>
            </div>

            <div class="flex"></div>

            <template is='dom-if' if='[[hasThreads(threads)]]'>
                <aq-pagination class="self-center"
                               per-page="[[perPage]]"
                               current-page="{{currentPage}}"
                               total-items="[[totalThreads]]">
                </aq-pagination>
            </template>

        </div>

        <paper-fab id='fab' noink icon="aq-icons:add" on-tap='createPost'></paper-fab>

        <paper-tooltip for='fab' offset="2" class='self-center iconTooltip' position="top" animation-delay="0"
                       fit-to-visible-bounds>New Post
        </paper-tooltip>
    </template>
    <script>

        Polymer({
            is: 'aq-community-home',

            properties: {
                selected: {
                    type: String,
                    value: 0,
                },

                threads: {
                    type: Array,
                    value: [],
                },

                searchParam: {
                    type: Object,
                },

                searchText: {
                    type: String,
                    value: "",
                },

                searchCategory: {
                    type: String,
                    value: "",
                },

                currentPage: {
                    type: Number,
                    value: 1,
                    observer: '_currentPageChanged',
                },

                perPage: {
                    type: Number,
                    value: 10,
                },

                totalThreads: {
                    type: Number,
                },

                aimsquant: Object,
                header: Object,

                personal: {
                    type: Boolean,
                    computed: 'isSelected(selected, 3)'
                },

                following: {
                    type: Boolean,
                    computed: 'isSelected(selected, 2)'
                },

                loading: Boolean,

                dirtyBit: {
                    type: Number,
                    value: 1,
                },

            },

            listeners: {
                'search-action': 'onSearch',
                'view-action': 'onView',
            },

            //observers:['_activeChanged(active, subroute)'],

            attached: function () {
                var x = localStorage.getItem('my-app-storage');
                if (x) {
                    var community = JSON.parse(x).community;
                    if (community) {
                        this.searchText = community.searchText;
                        this.searchCategory = community.searchCategory;
                        this.oldselected = community.searchTab;
                        this.selected = community.searchTab;
                        this.currentPage = community.lastPage;
                    }
                }

                if (!this.isSearchActive(this.searchText, this.searchCategory) || this.dirtyBit == 1) {
                    this.processparams();
                    this.dirtyBit = 0;
                }

            },

            isSelected: function (selected, selection) {
                return selected == selection;
            },

            onActivateTab: function () {
                if (this.selected != this.oldselected) {
                    this.oldselected = this.selected;

                    if (this.currentPage == 1) {
                        if (this.isAttached) {
                            this.processparams();
                        }
                    } else {
                        this.currentPage = 1;
                    }
                }
            },

            onGetAllThreadsResponse: function (data) {
                this.set('threads', []);
                this.threads = data.detail.response.threads;
                this.totalThreads = data.detail.response.count;
            },

            onGetAllThreadsError: function (data) {
            },

            createPost: function () {

                if (!this.$.authItem.checkHasToken()) {
                    this.fire('rt-changed', {route: '/user/signin'});
                    return;
                }

                this.updateCommunityState();

                this.fire('rt-changed', {route: '/dashboard/community/create'});
            },

            onSearch: function (e) {

                this.searchText = e.detail.text;
                this.searchCategory = e.detail.category;

                if (this.searchText == "") {
                    this.currentPage = 1;
                    this.dirtyBit = 0;
                } else {
                    this.dirtyBit = 1;
                }

                if (this.isAttached) {
                    this.processparams();
                }
            },

            isFollowing: function () {
                return this.selected == 2;
            },

            isPersonal: function () {
                return this.selected == 3;
            },

            processparams: function () {

                if (this.selected == 0) {
                    this.orderby = 'views';
                } else {
                    this.orderby = 'createdAt';
                }

                this.updateCommunityState();

                var currentPage = (this.currentPage) ? this.currentPage : 1;

                var category = this.searchCategory == "All" ? "" : this.searchCategory;

                this.searchParam = {
                    "skip": this.perPage * (currentPage - 1),
                    "limit": this.perPage,
                    "order": "-1",
                    "q": this.searchText,
                    "order_param": this.orderby,
                    "personal": this.isPersonal(),
                    "following": this.isFollowing(),
                    "category": category
                };

                this.fetchResults();

            },

            fetchResults: function () {
                if (this.$.authItem.checkHasToken()) {
                    this.header = this.$.authItem.getHeader();
                    var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                    this.$.getAllThreadsQuery.url = APIEndPoint + '/thread';
                    this.$.getAllThreadsQuery.generateRequest();
                }
            },

            _currentPageChanged: function (newPage, oldPage) {
                if (this.isAttached) {
                    this.processparams();
                    this.$$('#community-tabs').scrollIntoView(true);
                }
            },

            updateCommunityState: function () {
                this.fire('update-localstorage-community', {
                    searchText: this.searchText,
                    searchCategory: this.searchCategory,
                    lastPage: (this.currentPage) ? this.currentPage : 1,
                    searchTab: (this.selected) ? this.selected : 0
                });
            },

            isSearchActive: function (searchText, searchCategory) {
                return searchText.length > 0 || (searchCategory && searchCategory != "All" && searchCategory.length > 0);
            },

            hasThreads: function (threads) {
                return threads.length > 0;
            },

            setDirtyBit: function () {
                this.dirtyBit = 1;
                this.async(function () {
                    this.setDirtyBit
                }, 120000);
            },

            onPostAdded: function () {
                console.log("Post Added");
                this.dirtyBit = 1;
            },

            onSetDirtyBit: function (e) {
                this.dirtyBit = e.detail;
            },

        });
    </script>
</dom-module>
