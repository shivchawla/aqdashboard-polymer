<link rel='import' href='../../../bower_components/paper-fab/paper-fab.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../../../bower_components/paper-tabs/paper-tab.html'>
<link rel="import" href="../../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>

<link rel="import" href="./aq-community-home-searchbar.html">
<link rel="import" href="./aq-community-home-post-item2.html">
<link rel='import' href='../common/aq-pagination.html'>
<link rel='import' href='../../icons/aq-iconset.html'>

<dom-module id="aq-community-home">
    
    <style  include="iron-flex iron-flex-alignment iron-positioning">
    </style>
  
    <style>

        p {         
          font-size: 28px;
          margin-bottom: 0px;
        }

        #header {
          margin-bottom: 30px;
        }

        i {
          font-size :16px;
        }
    

        .insidetoolbar {
            outline-color: blue;
            border: solid;
        }

        input {
            font: inherit;
            font-size: 16px;
            color: black;
        }

        #container {
            margin:0 auto;
            margin-top: 20px;
            color: #24293d;
            width: 95%;
            margin-left: 2%;
            
            overflow-y: scroll;
          }


        #fab {
            background: teal;--#24293d;
            --float: right;
            position: fixed;
            right: 25px;
            bottom: 30px;

        }

        paper-tab:hover {
            font-weight: bold;
            font-size: 18px;
        }   

        #community-tabs {
            max-width: 350px;
            font-size: 16px;
            margin-top: 20px;
            border-bottom: 1px solid #e5e5e5;
            --paper-tabs-selection-bar-color: #cf6766; !important;
            margin-bottom: -10px;  
        }

        #allposts {
            margin-top: 50px;
            --margin-left:auto;
            margin-right: 0px;
            margin-left: 0px;
        }

        #ifsearch {
          display: none;
        }
          
        paper-tab.iron-selected {
          color: #cf6766; --teal;
        }

        paper-tooltip.iconTooltip {
          --paper-tooltip: {
              font-size: 13px;
              min-width: 40px;
              text-align: center;
          }

          --paper-tooltip-opacity: 1.0;
          --paper-tooltip-background: teal;
        }


    </style>
    <template>

        <iron-ajax
            url="http://localhost:3002/api/v2/thread"
            method='GET'
            id='getAllThreadsQuery'
            params='[[searchParam]]'
            handle-as="json"
            on-response="onGetAllThreadsResponse"
            on-error="onGetAllThreadsError"
            headers='{{header}}'
            debounce-duration="300">
        </iron-ajax>

        <iron-localstorage
          id = "localStorage"
          name = "my-app-storage" 
          value = "{{aimsquant}}">
        </iron-localstorage>

        <div id='container' class="layout vertical">
            
            <div class="layout horizontal wrap">
              <div id="header">
                <p> AimsQuant Community</p>
                <i style="margin-bottom:50px; color:teal;">Share, Learn and Code</i>
              </div>

              <div class="flex"></div>
  
              <aq-community-home-searchbar id='searchbar' 
                                      class="self-end"
                                      active="[[isSearchActive(searchText)]]"
                                      search-value="[[searchText]]">
              </aq-community-home-searchbar> 
            
            </div>
         
            <template is='dom-if' if='[[isSearchActive(searchText)]]'>
              <p style="font-size: 16px;">Search results for: 
                <i>"[[searchText]]"</i>
              </p>
            </template>
          
            <paper-tabs on-iron-select="onActivateTab" id="community-tabs" selected="{{selected}}" noink>
                <paper-tab id="popular">Popular</paper-tab>
                <paper-tab id="newest">Newest</paper-tab>
                <paper-tab id="following">Following</paper-tab>
                <paper-tab id="personal">Personal</paper-tab>
            </paper-tabs>

            <div id='allposts'>
                  <template is="dom-repeat" items="{{items}}" initial-count=10>
                      <aq-community-home-post-item2
                        topic-address="/dashboard/community/topics/{{item._id}}"
                        item-id = "{{item._id}}"
                        topic-heading="{{item.title}}"
                        author-firstname="{{item.user.firstName}}"
                        author-lastname="{{item.user.lastName}}"
                        author-address="{{item.user.email}}"
                        post-date="{{format(item.createdAt)}}"
                        total-replies="{{item.replies.length}}"
                        total-followers = "{{item.followers.length}}"
                        total-views="{{item.views}}"
                        post-category="{{item.category}}"
                        post-content="{{item.markdownText}}"
                        lastreply-author="[[getReplyAuthor(item)]]"
                        lastreply-date="[[getReplyDate(item)]]"
                        has-backtest="[[hasBacktest(item)]]">
                      </aq-community-home-post-item2>
                  </template>
                
            </div>

            <div class="flex"></div>
            <template is='dom-if' if='[[items]]'>
                <aq-pagination class="self-center" 
                                per-page="[[perPage]]"   
                                current-page="{{currentPage}}"
                                total-items="[[totalItems]]">
                                  
                </aq-pagination>
            </template>
        </div>
        
        <paper-fab id='fab' noik icon="aq-icons:add" on-tap='createPost'></paper-fab>

        <paper-tooltip for='fab' offset="2" class=' self-center iconTooltip' position="top" animation-delay="0" fit-to-visible-bounds>New Post</paper-tooltip>
        
    </template>
    <script>

        var options = {
            weekday: "long", year: "numeric", month: "short",
            day: "numeric", hour: "2-digit", minute: "2-digit"
        };

        Polymer({
            is: 'aq-community-home',

            properties: {
                selected: {
                    type: String,
                    value: 0
                },

                items: {
                    type: Object,
                },

                searchParam:{
                    type:Object,
                },

                searchText:{
                    type:String,
                    value:"",
                },

                searchCategory:{
                    type:String,
                    value:"",
                },

                currentPage: {
                  type:Number,
                  value:1,
                  observer: '_currentPageChanged',
                },

                perPage :{
                  type:Number,
                  value:10,
                },

                totalItems: {
                  type:Number,
                },

                aimsquant:Object,
                header:Object,

            },

            listeners :{
              'search-action':'onSearch',
              'view-action':'onView',
            },

            ready: function() {
                var x = localStorage.getItem('my-app-storage');
                var user = JSON.parse(x).user;
                if (user.token) {
                  this.header = {
                    "aimsquant-token": user.token,
                    "Content-Type": "application/json"};  
                }

                this.orderby = "views";
                 
            },

            attached: function() {
              var x = localStorage.getItem('my-app-storage');
              if (x) {
                  var community = JSON.parse(x).community;
                  if (community) {
                      this.currentPage = community.lastPage;
                      this.searchText = community.searchText;
                      this.searchCategory  =community.searchCategory;
                  } else {
                    this.aimsquant.community = {lastPage:1};
                    this.$.localStorage.save();
                  }
              }                  
            },

          
            isPersonalSelected: function() {
                return this.selected == 3;
            },

            onActivateTab: function() {
                if (this.selected == 1) {
                  this.orderby = 'createdAt';
                } else {
                  this.orderby = 'views';
                }

                this.processparams();
            },

            onGetAllThreadsResponse: function(data) {
              console.log(data.detail.response);
                this.items = data.detail.response.threads;
                this.totalItems = data.detail.response.count;
            },

            onGetAllThreadsError: function(data) {
                //console.log(data);         
            },

            createPost: function() {
                this.saveCurrentPage();

                if (!this.header) {
                  this.router.go('/user/signin', {lastRequest:'/dashboard/community/create'});
                  return;
                }

                this.router.go('/dashboard/community/create');
            },

            onSearch: function(e) {
              
              this.searchText = e.detail.text;
              this.searchCategory = e.detail.category;

               if(this.aimsquant) {
                this.aimsquant.community.searchText = this.searchText;
                this.aimsquant.community.searchCategory = this.searchCategory;

                if (this.searchText=="") {
                  this.currentPage = 1;
                  this.aimsquant.community.lastPage = this.currentPage;
                }

                this.$.localStorage.save();
              }

              this.processparams();
            },

            processparams: function() {
              this.searchParam = {"skip":this.perPage*(this.currentPage -1), "limit":this.perPage, "order":"-1", "q":this.searchText, "order_param":this.orderby, "personal":this.isPersonalSelected(), "category": this.searchCategory};

              this.$.getAllThreadsQuery.generateRequest();
            },

            format: function(date) {
              return new Date(date).toLocaleTimeString("en-us", options);
            },

            _currentPageChanged: function(newPage, oldPage) {       
              if (newPage !=oldPage) {
                this.saveCurrentPage();
              }

              
              this.fire('scroll-top');
              
              this.processparams();
            },

            saveCurrentPage: function() {
              if(this.aimsquant) {
                this.aimsquant.community.lastPage = this.currentPage;
                this.$.localStorage.save();
              }
            },

            
            getReplyDate: function(thread) {
              if (thread.replies.length > 0) {
                return this.format(thread.replies[thread.replies.length-1].createdAt);
              } else {
                return '';
              }
            },

            getReplyAuthor: function(thread) {
               if (thread.replies.length > 0) {
                var reply = thread.replies[thread.replies.length-1];
                return reply.user.firstName +" "+ reply.user.lastName;
              } else {
                return '';
              }
            },

            hasBacktest: function(thread) {
              if (thread.bactest){
                return true;
              }

              for(i=0;i<thread.replies.length;i++){
                if(thread.replies[i].backtest){
                  return true;
                }
              }

              return false;
            },

            isSearchActive: function(searchText) {
                return searchText.length > 0;
            },


        });
    </script>
</dom-module>
