
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>
<link rel='import' href='../../../bower_components/app-route/app-route.html'>
<link rel='import' href='../../../bower_components/app-route/app-location.html'>

<link rel="import" href="../common/aq-check-authentication.html">

<link rel="import" href="../aq-markdown-editor.html">
<link rel="import" href="./aq-community-previewpost.html">
<link rel="import" href="../../dialog/aq-community-attachbacktest-dialog.html">

<link rel='import' href='../common/aq-dropdown.html'>
<link rel='import' href='../../icons/aq-iconset.html'>

<dom-module id="aq-community-createpost">
    <style  include="iron-flex iron-flex-alignment iron-positioning"></style>
    
    <style>
      #container {
          width:90%;
          margin:0 auto;
          color:#24293d; 
          margin-top:10px;  
      }

      .goBackButton {
        margin-left: -7px;
        margin-bottom: 10px;
      }
   
      input {
        height: 42px;
        font-size: 18px;
        margin-bottom: 5px;
        color:#24293d;
        border:1px solid #e5e5e5;
        padding-left: 10px;
      }

      input:focus {
        outline: none;
      }

      aq-dropdown {
        --dropdown-width:220px;
        --dropdown-height:46px;
        --dropdown-button-color: teal;
        --dropdown-background-color: #f2fbf7;
        --dropdown-color: teal;
        
        --dropdown-item-border: 1px solid #cc6666;

      }

      p {         
          font-size: 28px;
          margin-bottom: 10px;
          margin-top:0px;
        }

      paper-button {
        border: 1px solid teal;#24293d;
        height:30px;
        font-size: 13px;
        color: teal; --white;
        background-color: white;
        border-radius: 5px;

      }

      #attachButton {
        position:absolute;
        top:195px;
        right:6%;
        z-index: 2;
        background-color: white !important;
        color: teal !important;
        border: none !important;
      }

      #attachButton{
        border:none !important;

      }

      #buttons {
        margin-bottom: 10px;
      }

      #errorMessage {
        color:#cc6666;
      }

      #attachedMessageDiv {
        display: none;
        color:#cc6666;
        font-size:14px;
      }

      #removeIcon {
        width:32px;
        height:32px;
      }


    </style>


    <template>

        <aq-check-authentication id='authItem'></aq-check-authentication>
        <app-location route="{{route}}" quer-params="{{queryParams}}" use-hash-as-path></app-location>

        <app-route
            route="{{route}}"
            pattern="/dashboard/community/create"
            active="{{active}}"
            query-params="{{queryParams}}">
        </app-route>

        <iron-ajax 
            url="" 
            body="{{threadData}}" 
            method='POST' 
            id='postThreadQuery' 
            headers='{{header}}' 
            handle-as="json" 
            on-response="onPostThreadResponse" 
            on-error="onPostThreadError" 
            debounce-duration="300">
        </iron-ajax>

        <iron-ajax
          url="[[computeFollowPostUrl(newThreadId)]]"
          method="POST"
          id='followPostQuery'
          handle-as="json"
          headers='{{header}}'
          debounce-duration="300">
        </iron-ajax>
        

            <template is='dom-if' if="[[preview]]">
              <aq-community-previewpost thread-data="[[threadData]]"></aq-community-previewpost>  
            </template>

            <aq-community-attachbacktest-dialog id='btDialog'>
            </aq-community-attachbacktest-dialog>  
           
            <template is='dom-if' if="[[!preview]]">
                <div id='container' class="layout vertical flex">
                    <div class="goBackButton layout horizontal">
                    <paper-icon-button noink class="self-center" title="Go Back" icon="aq-icons:arrow-back" on-tap="goBack"></paper-icon-button>
                    <div class="flex"><h4>Back to Community</h4></div>
                  </div>
                  
                    <div class="layout horizontal">
                      <p class="flex">Create a Post</p>
                      
                      <div id="attachedMessageDiv" class="layout horizontal self-end">
                        <i class="self-end">[[attachedMessage]]</i>
                        <paper-icon-button id='removeIcon' class="self-end" title="Remove" on-tap='onRemoveAttached' icon="aq-icons:remove-circle"></paper-icon-button>
                      </div>
                    </div>

                    <paper-button id='attachButton' raised noink on-tap='onAttachRequest'>Attach<iron-icon icon="aq-icons:attach-file"></iron-icon></paper-button>
                    
                    <div class="layout horizontal">
                        <aq-dropdown vertical-offset=46 id="category_dd" options="[[categories]]"></aq-dropdown>
                        <input id="topicInput" class="flex" label="Topic" placeholder="Heading of the Post">
                    </div>
                    
                    <aq-markdown-editor id="editor" placeholder="Describe in detail"></aq-markdown-editor>

                    <div id='buttons' class="layout horizontal">
                        <div id='errorMessage'><i>[[error]]</i></div>
                        <div class="flex"></div>
                        <paper-button raised noink on-tap='onPreview'>Preview</paper-button>

                        <paper-button raised noink on-tap="postThread">Submit</paper-button>
                    </div>

                </div>

            </template>
        
    </template>
    <script>
      

        Polymer({
            is: 'aq-community-createpost',

            properties: {
                threadData: Object,

                categories :{
                  type:Array,
                  value: [{value:"Share your Idea",index:0},{value:"Questions and Answers",index:1}],
                },

                preview:{
                  type:Boolean,
                  value:false,
                },

                error:String,

                header:Object,

                attachedBacktestId: {
                  type:String,
                  observer:'_backtestIdChanged',
                }, 

                attachedMessage: String,

                share: String,

                newThreadId: String,

                active:Boolean,
                queryParams:Object,

            },

            listeners :{
              'edit-clicked':'onEdit',
              'submit-clicked':'postThread',
              'backtest-attached':'onBacktestAttached',
            },

            observers:['_activeChanged(active, queryParams)'],

            computeFollowPostUrl: function(threadId) {
              var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
              return APIEndPoint+'/thread/'+threadId+'/follow';
            },

            postThread: function() {
                var x = this.processInput();
                
                if(x & this.$.authItem.checkHasToken()) {
                  this.header = this.$.authItem.getHeader();
                  var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                  this.$.postThreadQuery.url = APIEndPoint+'/thread';
                  this.$.postThreadQuery.generateRequest();
                }
            },
            
            onPostThreadResponse: function(data) {
                this.newThreadId = data.detail.response._id;
                
                if(this.$.authItem.checkHasToken()) {
                  this.header = this.$.authItem.getHeader(); 
                  this.$.followPostQuery.generateRequest();
                }

                this.resetView();
                this.fire('rt-changed', {route:"/dashboard/community/topics/"+this.newThreadId});

                this.fire('iron-signal', {name:'post-added'});
            },

            onPostThreadError: function(data) {
            },
                       
            onAttachRequest: function() {
                this.$$('#btDialog').open(); 
            },

            onBacktestAttached: function(e) {
                this.attachedBacktestId = e.detail.id;
                //this.handleAttachedBacktest();
            },

            handleAttachedBacktest: function() {
              if(this.attachedBacktestId && this.attachedBacktestId!="") {
                  this.attachedMessage = "Attached Backtest ID: "+this.attachedBacktestId;
                  this.$$('#attachedMessageDiv').style.display = 'block';
              } else {
                  this.attachedMessage = "";
                  if(this.$$('#attachedMessageDiv')) {
                    this.$$('#attachedMessageDiv').style.display = 'none';
                  }
              }
            },

            onRemoveAttached: function() {
              this.attachedBacktestId = "";
            },

            goBack: function() {
                this.fire('rt-changed',{route: '/dashboard/community'});
            },

            processInput: function() {
              const markdownText = this.$$('#editor').getContent();
              const category = this.$$('#category_dd').getSelectedValue();
             
              const title = this.$$('#topicInput').value;
              var x = localStorage.getItem('my-app-storage');
              var user = JSON.parse(x).user;

              var threadData = {
                  "category": category,
                  "title": title,
                  "markdownText": markdownText,
                  "user":{"firstName":user.firstName,"lastName":user.lastName},
                  "updatedAt": new Date(),
              };

              // Send to backedn only if available. Backend can't handle empty backtestids 
              if(this.attachedBacktestId && this.attachedBacktestId!="") {
                  threadData["backtestId"] = this.attachedBacktestId;
              }

              if(threadData["title"]!="" && 
                  threadData["category"]!="" &&
                  threadData["markdownText"]!=""
                ) {
                  
                  this.error = "";
                  this.threadData = threadData;
                  return true;
             
              } else {
                this.error = "No preview available for empty post. Please create a valid post and a header.";
                return false;
              }
            },

            onPreview: function() { 
              this.preview = this.processInput();   
            },

            onEdit: function() {
              this.threadData = {};
              this.preview = false;
            },

            _activeChanged: function(active, queryParams) {

                if(active) {
                  if(!this.$.authItem.checkHasToken()) {
                      this.fire('rt-changed', {route:'/user/signin'});
                      return;
                  }
                }
                
                this.resetView();

                if (active && queryParams.backtestId) {
                   this.attachedBacktestId = queryParams.backtestId;
                } 
            },

            resetView: function() {
                this.preview = false;
                this.attachedBacktestId = "";
                this.attachedMessage = "";
                this.threadData = {};

                if (this.$$('#editor')) {
                    this.$$('#editor').setContent("");
                    this.$$('#editor').focus();
                }

                if (this.$$('#topicInput')){
                    this.$$('#topicInput').value="";
                    this.$$('#topicInput').focus();
                }
            },

            _backtestIdChanged: function(nId, oId) {
                this.async(this.handleAttachedBacktest, 500);
            }

        });
    </script>
</dom-module>
