<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">

<link rel="import" href="./aq-community-postdetail-header.html">

<link rel="import" href="./aq-community-postdetail-content.html">
<link rel="import" href="./aq-community-postdetail-reply.html">


<dom-module id="aq-community-postdetail">

   <style>
    #container {
      margin-top: 20px;
      width:90%;
      margin-left: 0 auto;
      color: #333a56;
    }

    .goBackButton {
      margin-left: -7px;
      margin-bottom: 10px;
    }

    paper-icon-button {
      padding-left: 0px;
    }

  </style>

  
  <template>
    
      <iron-ajax
          auto
          url="http://localhost:3002/api/v2/thread/{{threadid}}"
          method='GET'
          id='thread'
          handle-as="json"
          on-response="onAllThreads"
          headers='{{header}}'
          debounce-duration="300">
      </iron-ajax>

      <template is="dom-if" if="{{threadDetails}}">
        <div id='container'>
          
          <div class="goBackButton layout horizontal">
            <paper-icon-button noink class="self-center" title="Go Back" icon="icons:arrow-back" on-tap="goBack"></paper-icon-button>
            <div class="flex"><h3>Back to community</h3></div>
          </div>
          
          <aq-community-postdetail-header
            post-header='{{threadDetails}}'>
          </aq-community-postdetail-header>
          
          <div id="replyContainer">
            <template is="dom-repeat" 
                      items="{{threadDetails.replies}}"
                      initial-count=5>
              <aq-community-postdetail-content item="{{item}}"></aq-community-postdetail-content>
            </template>
          </div>
          

          <aq-community-postdetail-reply id="replyEditor" threadid={{threadDetails._id}}></aq-community-postdetail-reply>
        </div>
      </template>

  </template>

  <script>
    Polymer ({
      is: 'aq-community-postdetail',
      properties: {
        threadid: {
          type: String
        }
      },

      listeners :{
        'goBackClicked':'goBack',
        'reply-added':'addReply',
      },

      onAllThreads(data) {
          this.threadDetails = data.detail.response;
      },

      ready: function() {
          var x = localStorage.getItem('my-app-storage');
          var user = JSON.parse(x).user;
          this.firstName = user.firstName;
          this.lastName = user.lastName;
          this.email = user.email;
          this.letter = this.firstName[0];
          this.header = {
              "aimsquant-token": user.token,
              "Content-Type": "application/json"
          };
      },
      goBack() {
          this.router.go('/dashboard/community');
      },

      addReply(e) {
        
        var reply = e.detail.reply;
        var replyElement = document.createElement('aq-community-postdetail-content');
        
        var x = localStorage.getItem('my-app-storage');
        var user = JSON.parse(x).user;

        reply.user = {"firstName":user.firstName, "lastName":user.lastName};
        
        replyElement.item = reply;

        this.$$("#replyContainer").appendChild(replyElement);
        this.$$("#replyEditor").clearEditor();
      }

    });

  </script>

</dom-module>
