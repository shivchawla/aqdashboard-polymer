
<!--link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html"-->
<link rel='import' href='../../../bower_components/chart-elements/chart-bar.html'>
<link rel='import' href='../../../bower_components/chart-elements/chart-line.html'>
<link rel='import' href='../../../bower_components/iron-pages/iron-pages.html'>
<link rel='import' href='../../../bower_components/iron-ajax/iron-ajax.html'>
<link rel='import' href='../common/aq-check-authentication.html'>

<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>

<link rel='import' href='../../icons/aq-iconset.html'>

<dom-module id='aq-analyze-backtest-comparison-item'>	
	<style  include="iron-flex iron-flex-alignment iron-positioning">
	</style>

	<style>	

		paper-icon-button {
			width:35px;
    		height:35px;
    		margin-right: 10px;
    		min-width:25px;
    		max-width:35px;
    		--color:#188364; 
		}

		#backButton {
			margin:auto 0;
			outline: none !important;
		}

		span {
			text-align: center;
			margin-top:15px;
		}

		.paper_align{
			position: absolute;
		    top: 20px;
		    right: 7px;
		}

		.pages_select{
			text-align: -webkit-center;
			margin: 30px 0 30px 10px;
		}

		vaadin-grid {
			--vaadin-grid-header-row-height : 78px;
			--vaadin-grid-row-cell: blue;
		}

		#table_details__comparison{
			overflow: scroll;width: 100%;
		}
		
		
		.sub_header{
			display: flex;
			justify-content: space-between;
		}
		
		.vertical-textGraphs {
			transform: rotate(270deg);
			margin-right: -40px;	
		}

		.horizontal-textGraphs {
			margin-top: -40px; 
		}

		#comparison-return {
			margin-top:0px;
			margin:0 auto;
			--width:95%;
		}

		paper-tab:hover{
    		font-weight: bold;
    		font-size:110%;
    	}

    	paper-tabs {
    		--paper-tabs-selection-bar-color: teal;
    	}

    	#cumRetLineChart {
    		--margin-left: -100px;
    		height:400px;
    		width:100%;
    		background-color:white;
    		border: 1px solid teal;
    		padding:10px;
    	}

    	#monthlyReturnBarChart {
    		--margin-left: -100px;
    		height:400px;
    		width:100%;
    		background-color:white;
    		border: 1px solid teal;
    		padding:10px;
    	}


	</style>

	<template>
		<aq-check-authentication id='authItem'></aq-check-authentication>	

		<div class="goBackButton layout horizontal">
            <paper-icon-button noink id='backButton' class="self-center" title="Go Back" icon="aq-icons:arrow-back" on-tap="goBackAllBacktests">
            </paper-icon-button>
            <p class="self-center">Back to All Backtests</p>
      	</div>
		
		<div id='comparison-return'>
			<div class="sub_header">
				<paper-tabs noink selected={{graphType1}}>
					<paper-tab>Total Return</paper-tab>
					<paper-tab>Monthly Returns</paper-tab>
					<!--paper-tab>Risk Metrics</paper-tab-->
				</paper-tabs>
			</div>
		          
			<iron-pages class="pages_select" selected={{graphType1}}>
							
				<chart-line 
		  			id="cumRetLineChart" 
		  			data="[[cumRetData]]"
		  			options="[[cumRetLineChartOptions]]">
		  		</chart-line>
			  	
  				<chart-bar 
		  			id="monthlyReturnBarChart" 
		  			data="[[monthlyReturnData]]"
		  			options="[[monthlyReturnBarChartOptions]]">
		  		</chart-bar>
		  	
	  			<!--div style="width:100%">
			  		<vaadin-grid size="0" id="table_details__comparison">
					  <table>
					    <colgroup class="table_style">
				    		<col name="Strategy Name" sortable/>
					      	<col name="Backtest Name" sortable/>
					      	<col name="Total Return" sortable/>
					      	<col name="Annual Return" sortable/>
					     	 <col name="Volatility" sortable/>
					      	<col name="Sharpe Ratio" sortable/>
					      	<!--col name="Information Ratio" sortable/>
					      	<col name="Sortino Ratio" sortable/>
					      	<col name="Avg Drawdown" sortable/-->
					      	<!--col name="Max Drawdown" sortable/-->
					      	<!--col name="Calmar Ratio" sortable/>
					      	<col name="Beta Value" sortable/>
					      	<col name="Stability" sortable/>
					      	<col name="Avg Concentration" sortable/-->
					    <!--/colgroup>
					  </table>
					</vaadin-grid>
				</div-->
	  		</iron-pages>
		</div>
		
		<div id='comparison-risk' class = "layout horizontal flex">
		</div>

		<iron-ajax
          	url="[[computeGetBacktestUrl(backtestId)]]"
     	 	method='GET'
          	id='getBacktestsQuery'
          	handle-as="json"
          	on-response="onGetBacktestSuccess"
          	on-error="onGetBacktestError"
          	headers='{{header}}'
          	debounce-duration="300">
        </iron-ajax>
				
	</template>

	<script>
		Polymer ({
			is:'aq-analyze-backtest-comparison-item',
			
			properties:{

				compareItems: {
					type:Object,
				},

				active:{
					type:Boolean,
					value:false,
					observer:'_isActiveChanged',
				},

				backtests:{
					type:Array,
					value:[],
				},

				cumRetData:{
					type:Object,
				},

				monthlyReturnData:{
					type:Object,
				},

				cumRetLineChartOptions:Object,
				monthlyReturnBarChartOptions:Object,

				tableData:{
					type:Array,
					value:[]
				},

				counter:{
					type:Number,
					value:0,
				},

				backtestId: String,

				graphType1: {
					type:Number,
					value:0,
				},

				header: Object,

			},

			attached: function() {
				this.resetComparison();
				this.cumRetLineChartOptions = {maintainAspectRatio:false,
					backgroundColor:"#fff",
						scales: {
				            xAxes: [{
				                ticks: {
				                    maxTicksLimit:10,
				                    maxRotation:0,
				                    callback: function(value, index, values) {
					                        var date = new Date(value);
											var month = (date.getMonth() + 1);
											var month = month >= 10 ? month.toString() : '0'+month.toString();
											return date.getDate()+'/'+ month + '/' +  date.getFullYear();
				                    },
				                    fontColor:"#24293d",
				                    padding:20,
				                },
						      	scaleLabel: {
							        display: true,
							        labelString: 'Date',
							        fontSize: 16,
							        fontColor:"#24293d",
					            },
				             	gridLines:{
					            	display:false,
					            },
					        }],
			                
			                yAxes: [{
				                ticks: {
				                    maxTicksLimit:5,
				                    fontColor:"#24293d",
				                    padding:20,
				                    callback: function(value, index, values) {
				                    	return value+'%';
				                    },
				                },
						      	scaleLabel: {
							        display: true,
							        //labelString: 'Total Return (%)',
							        fontSize: 16,
							        fontColor:"#24293d",
					            },
				             	gridLines:{
					            	color:"#008080",
					            },
				              	position:"right",
					            gridLines :{
					            	drawTicks:false,
				                    tickMarkLength:0,
				                    drawBorder:true,
					            },
					        }]
				        }
		        };

		        this.monthlyReturnBarChartOptions = {maintainAspectRatio:false,
						scales: {
							paddingBottom:10,
				            xAxes: [{
				                ticks: {
				                    maxTicksLimit:10,
				                    maxRotation:0,
				                    callback: function(value, index, values) {
					                        var year = Math.floor(value / 100);
											var month = value % 100;
											var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug",
											 "Sep", "Oct", "Nov", "Dec"];
											return monthNames[month - 1] +" "+year.toString();
				                    },
				                    fontColor:"#24293d",
				                    padding:20,
				                },
						      	scaleLabel: {
							        display: true,
							        labelString: 'Month/Year',
							        fontSize: 16,
							        fontColor:"#24293d",
					            },
					            gridLines:{
					            	display:false,
					            },

					            paddingLeft:10,
								
					        }],
			                yAxes: [{
				                ticks: {
				                    maxTicksLimit:5,
				                    //fontSize: 14,
							        fontColor:"#24293d",
							        padding:20,
							        callback: function(value, index, values){
							        	return value+'%';
							        },
				                },
				                scaleLabel: {
							        display: true,
							        //labelString: 'Monthly Return (%)',
							        fontSize: 16,
							        fontColor:"#24293d",
					            },
				             	gridLines:{
					            	color:"#008080",
					            },
					        }]
			            },
		        };

				if (this.active){
					this.doComparison();
				}
			},

			_isActiveChanged: function(newVal, oldVal) {
				if (oldVal+1 && newVal) {
					this.resetComparison();
					this.doComparison();
				}
			},

			computeGetBacktestUrl: function(backtestId) {
				var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
				return APIEndPoint + '/backtest/' + backtestId;
			},

			doComparison: function() {
				for(var key in this.compareItems) {	
					if(this.compareItems[key]) {
						if (!this.backtests[key] ) {
							
							this.backtestId = key;
							if(this.$.authItem.checkHasToken()) {
								this.header = this.$.authItem.getHeader();
								this.$.getBacktestsQuery.generateRequest();
							}

						} else {
							this.addBacktestToComparison(this.backtests[key]);
						}
					}
				}
			},

			onGetBacktestSuccess: function(e){
				var backtest = e.detail.response;
				this.backtests[backtest._id] = backtest;
				this.addBacktestToComparison(backtest);
			},
			
			addBacktestToComparison: function(backtest){	
				this.processLineChartData(backtest);
				this.processBarChartData(backtest);
				//this.processMetricsData(backtest);
				this.counter++;

				/*if (this.counter == Object.keys(this.compareItems).length) {
					var grid = this.$.table_details__comparison;
					grid.items = this.tableData;
					grid.frozenColumns = 2;
				}*/
			},

			processLineChartData: function(data) {
				var colors = ["#fc4a1a","#0375b4","#FFAA1D","#007849","#6e2667"];
				var equityData = data.output.totalreturn.algorithm;
				var keys = Object.keys(equityData);
				var yPoints = new Array(keys.length);
				var xPoints = new Array(keys.length);
				
				var dataset = {
						label:data._id,
						borderColor:colors[this.counter],
						borderWidth:1,
						fill:false,
						pointRadius:0,
						pointHoverRadius:10,
					};
				
				keys.sort()
      			.forEach(function(v, i) {
      				yPoints[i] = equityData[v];
      				xPoints[i] = v;
       			}); 

       			dataset.data = yPoints;

				//var yAxisLabel = "Total Return (%)";
				this.push('cumRetData.datasets', dataset);

				if(!this.cumRetData.labels) {
					this.set('cumRetData.labels', xPoints);
				}
				
				this.$$('#cumRetLineChart').updateChart()	
			},

			processBarChartData: function(data) {
				var colors = ["#fc4a1a","#0375b4","#FFAA1D","#007849","#6e2667"];
				var aggregatedReturns = data.output.returns.monthly.algorithm;
				var keys = Object.keys(aggregatedReturns);
				var yPoints = new Array(keys.length);
				var xPoints = new Array(keys.length);

				var dataset = {
						label:data._id,
						borderColor:colors[this.counter],
						backgroundColor:colors[this.counter],
						borderWidth:2,
						//fill:false,
						//pointRadius:1,
						//pointHoverRadius:10,
					};

				var i = 0;

				keys.sort()
      			.forEach(function(v, i) {
      				yPoints[i] = aggregatedReturns[v];
      				xPoints[i] = v;
       			}); 

			
      			dataset.data = yPoints;

      			this.push('monthlyReturnData.datasets', dataset);

      			if(!this.monthlyReturnData.labels) {
      				this.set('monthlyReturnData.labels', xPoints);
      			}

	  			this.$$('#monthlyReturnBarChart').updateChart();
			},

			processMetricsData: function(data){
				
				var metrics = data.output.analytics.rolling;
				var id = data._id;
				var strategyId = data.strategy;
				this.tableData.push({
		            'Strategy Name': strategyId,
		            'Backtest Name': id,
		            'Total Return': metrics.totalreturn,
		            'Annual Return': metrics.annualreturn,
		            'Volatility': metrics.annualstandarddeviation,
		            'Sharpe Ratio': metrics.sharperatio,
		            //'Information Ratio': metrics.informationratio,
		            //'Sortino Ratio': analytics.so,
		            //'Avg Drawdown': e.detail.response.result[i].Avg_Drawdown,
		            'Max Drawdown': metrics.maxdrawdown,
		            //'Calmar Ratio': e.detail.response.result[i].Calmar_Ratio,
		            //'Beta': e.detail.response.result[i].Beta,
		            //'Stability': e.detail.response.result[i].Stability,
		            //'Avg Concentration': e.detail.response.result[i].Avg_Concentration

		        });			
			},

			resetComparison: function() {
				this.cumRetData = {datasets:[]};
				this.monthlyReturnData = {datasets:[]};
				this.tableData = [];
				this.counter = 0;
			},

			goBackAllBacktests: function() {
				this.resetComparison();
	          	this.fire('comparison-off');
	        },

		});
	</script>
</dom-module>
