
<link rel='import' href='../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../../bower_components/app-route/app-route.html'>
<link rel='import' href='../../../bower_components/app-route/app-location.html'>
<link rel='import' href='../../../bower_components/iron-signals/iron-signals.html'>
<link rel='import' href='../../../bower_components/paper-icon-button/paper-icon-button.html'>
<link rel='import' href='../../../bower_components/paper-header-panel/paper-header-panel.html'>

<link rel='import' href='../common/aq-check-authentication.html'>
<link rel="import" href="../common/aq-loading-progress.html">

<link rel='import' href='./aq-analyze-home-menu.html'>
<link rel='import' href='./aq-analyze-home-backtest-item2.html'>

<link rel='import' href='./aq-analyze-backtest-comparison-item.html'>

<link rel='import' href='../../dialog/aq-delete-dialog.html'>
<dom-module id="aq-analyze-home">

	<style  include="iron-flex iron-flex-alignment iron-positioning">
	</style>

	<style>

		#container {
			margin:0 auto;
		    margin-top: 30px;
		    color: #24293d;
	  	}
		.backtest-item{
			width: 95%;
		}

	  	#dialog{
			width:80%;
			--height:80%;
		}

		#comparison {
			margin:20px;
			--height:400px;
		}

		.spacer {
			margin-bottom: 13px;
			height:0px;
			min-width: 500px;
		}

		paper-button {
			text-transform: none;
			font-size: 14px;
			color:#cc6666;
		 	margin-bottom: 10px;
            margin-left: 5px;
		}

	</style>

	<template>

		<iron-ajax
          	url="[[computeGetStrategyUrl(strategyId)]]"
     	 	method='GET'
          	id='getStrategyQuery'
          	handle-as="json"
          	on-response="onGetStrategy"
          	on-error="onGetStrategyError"
          	headers='{{header}}'
          	debounce-duration="300"
          	loading='{{strategyLoading}}'>
        </iron-ajax>

		<iron-ajax
          	url="[[computeGetAllBacktestsUrl(strategyId)]]"
     	 	method='GET'
          	id='getBacktestsQuery'
          	handle-as="json"
          	on-response="onGetAllBacktestsForStrategy"
          	on-error="onGetAllBacktestsForStrategyError"
          	headers='{{header}}'
          	params='[[searchParams]]'
          	debounce-duration="500"
          	loading='{{backtestLoading}}'>
        </iron-ajax>

		<iron-ajax
          	url="[[computeDeleteBacktestUrl(deleteId)]]"
     	 	method='DELETE'
          	id='deleteBacktestQuery'
          	handle-as="json"
          	on-response="onDeleteBacktestForStrategySuccess"
          	on-error="onDeleteBacktestForStrategyError"
          	headers='{{header}}'
          	debounce-duration="300">
        </iron-ajax>

        <aq-check-authentication id='authItem'></aq-check-authentication>

	 	<iron-signals on-iron-signal-backtest-added='onBacktestAdded'></iron-signals>

	 	<iron-signals on-iron-signal-backtest-completed='onBacktestCompleted'></iron-signals>

	 	<iron-signals on-iron-signal-dirtybit='onSetDirtyBit'>
	 	</iron-signals>
		
		<iron-signals on-iron-signal-select-backtest="selectAllBacktest">
		</iron-signals>
		
		<aq-loading-progress loading='{{isLoading(strategyLoading, backtestLoading)}}'></aq-loading-progress>

		<div class="fit"> 
	        <paper-header-panel fixed mode="seamed">
		        <template is="dom-if" if="[[!showComparison]]">
			        <aq-analyze-home-menu
			        	check-all="{{checkAll}}"
			        	num-active-backtests="[[checkedCount]]"
		              	strategy-name="{{strategyName}}"
		              	class="paper-header">
		          	</aq-analyze-home-menu>
		        </template>

		        <template is='dom-if' if='{{!isLoading(strategyLoading, backtestLoading)}}'>
					<div id='container'>

						<template is='dom-if' if="[[!showComparison]]">
							<!--paper-button noink id='backButton' class="self-center" title="Go Back" on-tap='goToEditor'><iron-icon icon="chevron-left" ></iron-icon> Back</paper-button-->

							<div class="layout vertical center">

								<template is='dom-repeat' items="{{backtests}}" initial-count=10>
									<aq-analyze-home-backtest-item2  class="backtest-item"  index="{{index}}" backtest="{{item}}" detail-icon=1 share-icon=1></aq-analyze-home-backtest-item2>
								</template>

								<template is='dom-if' if='[[isBacktestCountOdd(backtests)]]'>
									<div class="spacer"></div>
								</template>

							</div>
						</template>
					</div>
				</template>
			</paper-header-panel>

			<template is='dom-if' if="[[showComparison]]">
				<aq-analyze-backtest-comparison-item strategy-name="{{strategyName}}" compare-items="[[checkedItems]]" index-array="[[getIndexArray(checkedItems)]]" active="[[showComparison]]">
				</aq-analyze-backtest-comparison-item>
			</template>

		</div>

	    <aq-delete-dialog id ="deleteDialog" heading="Delete Backtests"
			 message="Are you sure to delete [[checkedCount]] backtest[[getMessageSuffix(checkedCount)]]?"
			 cancel="Cancel"
			 accept="OK">
    	</aq-delete-dialog>

	</template>

    <script>
    	Polymer({
    		is: 'aq-analyze-home',

    		properties: {

    			strategyName: String,

    			strategyId: {
					type:String,
					observer:'_strategyIdChanged',
				},

    			backtests: {
    				type:Array,
       			},

       			deleteId: String,

    			checkedCount: {
    				type: Number,
    				value:0,
    			},

    			checkedItems: {
					type:Object,
					value:{},
				},

				showComparison :{
					type:Boolean,
					value:false,
				},

				routeData: {
					type:Object,
				},

				subroute:Object,

				strategyLoading:Boolean,

				backtestLoading:Boolean,

				dirtyBit: {
					type: Number,
					value: 1,
					observer:'_dirtyBitChanged',
				},

				searchParams:{
					type:Object,
					value:{},
				},

				perPage:{
					type:Number,
					value:0,
				},

				currentPage:{
					type:Number,
					value:1,
				},

                checkAll:{
				    type:Boolean,
                    value:false
                },
				indexArray:{
                	type:Array,
					value:[]
				}

    		},

    		listeners: {
				'backClicked':'goToEditor',
				'compareClicked':'toggleComparison',
				'backtestChecked':'checkBacktest',
				'deleteClicked':'openDeleteDialog',
				'shareClicked':'goToShare',
				'comparison-off':'toggleComparison',
				'delete-action':'onDeletion',
				'detail-action':'onDetail',
			},

            attached: function () {
            	this.resetView();
            },

            resetView: function() {
	        	this.showComparison = false;
	        	this.checkedCount = 0;
	        	this.checkedItems = {};
                this.checkAll = false;
	        },

			_strategyIdChanged: function(nId, oId) {

				if(nId && nId!= "") {
					this.fetchBacktests();
	        	}
			},

			_dirtyBitChanged: function(nBit, oBit) {
				if(this.dirtyBit == 1 && this.strategyId) {
					this.fetchBacktests();
				}
			},

			fetchBacktests: function() {
				if(!this.$.authItem.checkHasToken()) {
         	 		this.fire('rt-changed',{route:'/user/signin'});
	          		return;
	          	} else {

					this.set('backtests', []);
	        		this.header = this.$.authItem.getHeader();
        			this.$.getStrategyQuery.generateRequest();
        			this.dirtyBit = 0;

	        	}
			},

	      	computeGetStrategyUrl: function(strategyId) {
	      		var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
	      		return APIEndPoint+'/strategy/'+strategyId;
	      	},

	      	computeDeleteBacktestUrl: function(deleteId){
	      		var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
	      		return APIEndPoint+'/backtest/'+deleteId;
	      	},

	      	computeGetAllBacktestsUrl: function(strategyId){
	      		var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
	      		return APIEndPoint+'/strategy/'+strategyId+'/backtests';
	      	},

			goToEditor: function() {
				this.fire('rt-changed', {route:'/dashboard/editor'});
			},

			goToShare: function(e) {
    			this.fire('rt-changed' ,{route:'/dashboard/community/create?backtestId='+e.detail.id});
			},

			isBacktestCountOdd: function(backtests) {
				return backtests.length % 2 == 1;
			},

			onGetAllBacktestsForStrategy: function(data) {

				if(this.backtests.length == 0) {
					this.backtests =  data.detail.response;
				} else {
					this.backtests.push(data.detail.response);
				}

				this.dirtyBit = 0;
			},

			onGetAllBacktestsForStrategyError: function(err) {
			},

			onGetStrategy: function(data) {
				this.strategyName = data.detail.response.name;

				this.searchParams = {"skip":this.perPage*(this.currentPage -1), "limit":this.perPage};

				this.$.getBacktestsQuery.generateRequest();
			},

			onGetStrategyError: function(data) {
			},

			checkBacktest: function(e) {
				var checked = e.detail.checked;
	        	this.checkedItems[e.detail.id] = {checked: e.detail.checked, index: e.detail.index};

	        	if (checked == true) {
	        		this.checkedCount += 1;
                    if(this.indexArray.indexOf(e.detail.index) == -1)
                        this.push('indexArray',e.detail.index);
	        	} else {
	        		this.checkedCount -= 1;
                    this.splice('indexArray',this.indexArray.indexOf(e.detail.index),1);
	        	}
	        	
	        	if(this.checkedCount > this.backtests.length)
	        	    this.checkedCount = this.backtests.length;
	        	
	        	this.checkAll = this.checkedCount == this.backtests.length;
	        },

	        getIndexArray: function(checkedItems) {
	        	var indexArray = new Array();
	        	for (var key in checkedItems) {
	        		indexArray.push(checkedItems[key].index);
	        	}

	        	return indexArray;
	        },

	        numCheckedBacktests: function(checkedCount) {
	        	return checkedCount;
	        },

	        getMessageSuffix: function(checkedCount) {
        		return checkedCount > 1 ? "s" :"";
        	},

	        openDeleteDialog: function() {
	        	this.$$('#deleteDialog').open();
	        },

	        onDeletion: function(e) {
	        	e.stopPropagation();
	        	//Send DELETE request to backend
	        	for (key in this.checkedItems) {
	        		var idx = this.backtests.map(function(x) {return x._id;}).indexOf(key);
	        		if(idx != -1 && this.checkedItems[key].checked == true) {
	        			this.deleteId = key;
        				this.$.deleteBacktestQuery.generateRequest();
	        		}
        		}

	    		this.deleteId="";
                this.checkAll = false;
	        },

	        onDeleteBacktestForStrategySuccess: function(data) {
	        	var deleteId = data.detail.response.backtestId;
	        	var idx = this.backtests.map(function(x) {return x._id;}).indexOf(deleteId);

	        	if(idx != -1) {
	        		this.splice('backtests', idx, 1);
	        		console.log(this.backtests);
    				this.checkedCount -= 1;
    				delete this.checkedItems[deleteId];
    				this.fire('iron-signal', {name:'backtest-deleted'});
	        	}

	        	if(this.backtests.length == 0) {
	        		this.fire('rt-changed', {route:'/dashboard/editor'});
	        	}
	        },

	        onDeleteBacktestForStrategyError: function(data) {
	        },

	        toggleComparison: function() {
	        	this.showComparison = !this.showComparison;
	        },

	        onDetail: function(e) {
	        	e.stopPropagation();
	        	this.fire('rt-changed', {route:'/dashboard/analyze/' + this.strategyId+'/'+ e.detail.id , index:e.detail.index});
	        },

	        onBacktestAdded: function() {
	        	this.dirtyBit = 1;
	        },

	        onBacktestCompleted: function() {
	        	this.dirtyBit = 1;
	        },

	        onSetDirtyBit: function(e) {
	        	this.dirtyBit = e.detail;
	        },

	        isLoading: function(strategyLoading, backtestLoading) {
	        	return strategyLoading || backtestLoading;
	        },
			selectAllBacktest:function (e) {

			}

    	});
    </script>

</dom-module>