<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-router/app-router.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../layouts/aq-dashboard-main.html">
<link rel="import" href="../components/user/aq-user-login-panel.html">

<link rel="import" href='../components/aq-homepage.html'>
<link rel="import" href='../components/aq-aboutpage.html'>
<link rel="import" href='../components/aq-investmentpage.html'>

<link rel="import" href='../components/aq-sidebar.html'>
<link rel="import" href='../components/aq-toolbar.html'>
<link rel="import" href='../dialog/aq-sendfeedback-dialog.html'>
<link rel="import" href='../dialog/aq-invitefriend-dialog.html'>

<dom-module id="aq-dashboard">
    <style>
      
      :host {
        display: block;
      }

      #mainpanel {
        height:100%;
        --background-color: #fafafa;
      }

      .paper-header {
        position: relative;
      }

    paper-drawer-panel {
      height:100%;
      background-color: #EFEFEF;--D9D9D9;--#E0F2F1

    }
    </style>
    
    
    <template>
        <iron-localstorage
            id='localStorage'
            name="my-app-storage"
            value="{{aimsquant}}"
            on-iron-localstorage-load-empty="initializeDefaultValue">
        </iron-localstorage>
  
      <div id="main">
        <paper-drawer-panel id="drawerpanel" force-narrow="[[computeForceNarrow(narrow, showSidebar)]]" responsive-width='900px' drawer-width="[[drawerWidth]]" narrow="{{narrow}}">
            
            <aq-sidebar menu-selected="{{view}}" drawer></aq-sidebar>
            
        
            <paper-header-panel id="mainpanel" main fixed mode="seamed">
              <aq-toolbar has-token="{{hasToken}}" current-tab="{{currentTab}}" class="paper-header" showMenu="[[computeShowMenu(narrow, showSidebar)]]"></aq-toolbar>

            <app-router id="router" class="flex" mode="hash" trailingSlash="ignore">
            
              <app-route path="/" redirect="/main"></app-route>
              <app-route path="/user" element="aq-user-login-panel" bindrouter="" onurlchange=""></app-route>

              <app-route path="/user/:displayMode" element="aq-user-login-panel" bindrouter="" onurlchange=""></app-route>

              <app-route path="/main" element="aq-homepage" bindrouter=""></app-route>

              <app-route path="/about" element="aq-aboutpage" bindrouter=""></app-route>

              <app-route path="/investments" element="aq-investmentpage" bindrouter=""></app-route>

              <app-route path="/dashboard" redirect="/dashboard/home"></app-route>

              <app-route path="/dashboard/*" element="aq-dashboard-main" bindrouter=""></app-route>

              <app-route path="*" element="aq-dashboard-main" bindrouter="" onurlchange=""></app-route>

            </app-router>

          </paper-header-panel>
        </paper-drawer-panel>

        <aq-sendfeedback-dialog id='feedbackDialog'>
        </aq-sendfeedback-dialog>

        <aq-invitefriend-dialog id='inviteDialog'">
        </aq-invitefriend-dialog>

      </div>

  </template>

  <script>
    Polymer({

        is: 'aq-dashboard',

        properties: {
          narrow: {
            type:Boolean,
            value:false,
          },

          showSidebar:{
            type:Boolean,
            value:true,
          },

          view: {
            type:String,
          },

          isHomeSelected :{
            type:Boolean,
            value:false,
          },

          isEditorSelected :{
            type:Boolean,
            value:false,
          },

          isCommunitySelected :{
            type:Boolean,
            value:false,
          },

          isAnalyzeSelected :{
            type:Boolean,
            value:false,
          },

          isHelpSelected :{
            type:Boolean,
            value:false,
          },

          hasToken: {
              type:Boolean,
              value:false,
          },

          currentTab:{
            type:Number,
            value:0,
          },

          aimsquant:{
            type: Object,
            notify: true,
          },

          drawerWidth:{
            type:String,
            value:"0px",
          },

        },

        listeners: {
            'open-menu': 'openMenu',
            'close-menu':'closeMenu',
            'change-view-navigation':'viewChanged',
            'change-view-action':'viewChangedOnAction',
            'loginClicked':'gotoSignin',
            'signupClicked':'gotoSignup',
            'tabChanged':'changeTab',
            'signout-action':'onSignOut',
            'take-feedback-action':'openFeedbackDialog',
            'send-feedback-action':'sendFeedBack',
            'enter-invite-action':'openInviteDialog',
            'send-invite-action':'sendInvite',
            'myaccount-action':'onMyAccount',
        },

        attached() {
            var path = ['home','editor','community','analyze','help'];

            for (i in path) {
                var c = document.URL.match('/dashboard/' + path[i]) ? true : false;
                
                if (c && this.view != path[i]) {  
                      
                      if (path[i] == 'analyze') {
                        this.view = 'editor';
                        
                      } else {
                        this.view = path[i];  
                        
                      }

                      break;   
                }
            }
        },
        
        checkHasToken() {
          
          var x = localStorage.getItem('my-app-storage');
          if (x) {
            var user = JSON.parse(x).user;
            console.log(user);
            //console.log(user.token);
            this.hasToken = (user && user.token) ? true : false;  
          } else {
            this.hasToken = false;
          }

          //console.log(this.hasToken);

          //return true;
        },

        computeShowMenu(narrow, showSidebar) {
          return narrow || !showSidebar;
        },

        computeForceNarrow(narrow, showSidebar) {
          return !showSidebar;
        },

        computeShowSideBar(narrow, showSidebar){
          return !showSidebar;
        },

        viewChanged(newMenu) {
          this.view = newMenu.detail.menu;
          /*this.isHomeSelected= this.view=='home';
          this.isEditorSelected = this.view=='editor';
          this.isCommunitySelected = this.view=='community';
          this.isAnalyzeSelected = this.view=='analyze';
          this.isHelpSelected = this.view=='help';*/
          
          this.$.router.go('/dashboard/' + this.view);
          
          if(this.narrow){
            this.$.drawerpanel.closeDrawer();
          }
        },

        viewChangedOnAction(newAction) {
          console.log(newAction.detail.action);
          if(newAction.detail.action == "sendfeedback") {
            this.openFeedbackDialog();
          } else if(newAction.detail.action == "invitefriend") {
            this.openInviteDialog();
          } {
            this.$.router.go('/dashboard/' + newAction.detail.action);
          }

          if(this.narrow){
            this.$.drawerpanel.closeDrawer();
          }
        },

        openMenu(e) {
          this.$.drawerpanel.openDrawer();
          this.showSidebar = true;
        },

        closeMenu() {
          this.$.drawerpanel.closeDrawer();

          if (this.showSidebar && !this.narrow) {
            this.showSidebar = false;
          }
        },

        initializeDefaultValue: function () {
            //localstorage.removeItem('my-app-storage');
            this.aimsquant = {user:''};
        },

        changeTab(e) {
          this.checkHasToken();
          this.showSidebar = (e.detail.tab == 1);
          tab = e.detail.tab;
          if (tab == this.currentTab) {
            return
          }

          path = ['/main', 
                  '/dashboard', 
                  '/investments', 
                  '/about',
                  '/user/signin',
                  '/user/signup'];

          this.currentTab = tab;

          if (this.currentTab == 1) {
            //this.view = "dashboard";
            this.drawerWidth ="200px;"
          }

          if (this.URLcontains(path[tab])) {
            return;
          } else {
            this.$$('#router').go(path[tab]);
          }
          
        },

        URLcontains(path) {
          return (document.URL.match(path)) ? true : false;
        },

        onSignOut() {
          console.log("Sign Out");
          this.set('aimsquant.user','');
          this.$.localStorage.save();

          //this.$.localstorage.value = null;
          console.log(localStorage.getItem('my-app-storage'));
 
          //this.$.localstorage.reload();

          console.log("Aimsquant: " + this.aimsquant.user);
          this.$.router.go('/user/signout');
        },

        openFeedbackDialog() {
          this.$.feedbackDialog.open();
        },

        sendFeedBack(e){

        },

        openInviteDialog() {
          this.$.inviteDialog.open();
        },

        sendInvite(e) {
        },

        onMyAccount() {
          this.$.router.go('/user/myaccount');
        },

        _aimsquantChanged(newvalue, oldvalue) {
          //this.checkHasToken();
        },

    });
  </script>
</dom-module>
