<link rel='import' href='../../bower_components/iron-pages/iron-pages.html'>
<link rel='import' href='../../bower_components/iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../../bower_components/app-route/app-route.html'>
<link rel='import' href='../../bower_components/app-route/app-location.html'>

<link rel="import" href="../../bower_components/iron-lazy-pages/iron-lazy-pages.html">
<link rel="import" href="../../bower_components/iron-lazy-pages/iron-lazy-page.html">

<link rel="import" href="./aq-home-main.html">
<link rel="import" href="./aq-editor-main.html">
<link rel="import" href="./aq-analyze-main.html">
<link rel="import" href="./aq-community-main.html">
<link rel="import" href="./aq-help-main.html">

<link rel="import" href='../components/aq-sidebar.html'>
<link rel="import" href='../components/aq-toolbar.html'>

<link rel="import" href='../components/aq-homepage.html'>
<link rel="import" href='../components/aq-aboutpage.html'>
<link rel="import" href='../components/aq-investmentpage.html'>

<dom-module id="aq-dashboard-main">
  
  <style include="iron-flex iron-flex-alignment iron-positioning">
  </style>

  <style>
    #content {
      --overflow: auto;
      background-color:#fafafa;
    }

  </style>

  <template>

        <app-location route="{{route}}" use-hash-as-path></app-location>
        <app-route route="{{route}}"
                    pattern="/dashboard/:page"
                    data="{{routeData}}"
                    tail="{{tail}}">
        </app-route>

        <aq-check-authentication id='authItem'></aq-check-authentication>

        <iron-ajax
            url=""
            method='PUT'
            id='updateForwardtestQuery'
            handle-as="json"
            on-response="onUpdateForwardtestSuccess"
            on-error="onUpdateForwardtestError"
            headers='{{header}}'
            debounce-duration="300"
            loading='{{loading}}'>
        </iron-ajax>

        <iron-ajax
            url=""
            method='DELETE'
            id='deleteForwardtestQuery'
            handle-as="json"
            on-response="onDeleteForwardtestSuccess"
            on-error="onDeleteForwardtestError"
            headers='{{header}}'
            debounce-duration="300"
            loading='{{loading}}'>
        </iron-ajax>

        <div id='content'>
          <iron-lazy-pages attr-for-selected="page" selected="{{routeData.page}}" fallback-selection="editor">
            <template is="iron-lazy-page" page="editor">
                <aq-editor-main></aq-editor-main>
            </template>

            <template is="iron-lazy-page" page="analyze">
                <aq-analyze-main></aq-analyze-main>
            </template>

            <template is="iron-lazy-page" page="community">
                <aq-community-main></aq-community-main>
            </template>
            
            <template is="iron-lazy-page" page="help">
                <aq-help-main></aq-help-main>
            </template>
          </iron-lazy-pages>
        </div>

  </template>

  <script>
      Polymer({
          is:'aq-dashboard-main',
          
          properties:{

            routeData:{
              type:Object,
            },
            
          },
          
          listeners :{
            'stoptest-action':'onStopForwardTest',
            'deletetest-action': 'onDeleteForwardTest',
          },

          onStopForwardTest: function(e) {
              var forwardtestIds = e.detail.forwardtestIds;
              
              forwardtestIds.forEach(forwardtestId => {
                  if(this.$.authItem.checkHasToken()) {
                      //this.testUpdateData = {active: false};
                      var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                    this.$$('#updateForwardtestQuery').url = APIEndPoint + "/forwardtest/" + forwardtestId +'?active=false';

                      this.header = this.$.authItem.getHeader();
                      this.$.updateForwardtestQuery.generateRequest()
                  }

              });
              
          },

          onDeleteForwardTest: function(e) {
              var forwardtestId = e.detail.forwardtestId;
              console.log("Here in Delete");
              if(this.$.authItem.checkHasToken()) {
                  //this.testUpdateData = {active: false};
                  var APIEndPoint = new Polymer.IronMetaQuery({key: 'APIEndPoint'}).value;
                this.$$('#deleteForwardtestQuery').url = APIEndPoint + "/forwardtest/" + forwardtestId;

                  this.header = this.$.authItem.getHeader();
                  this.$.deleteForwardtestQuery.generateRequest()
              }
          },

          onUpdateForwardtestSuccess: function(e) {
              this.fire('iron-signal', {name:'forwardtest-stopped'});
          },

          onUpdateForwardtestError: function(e) {
          },

          onDeleteForwardtestSuccess: function(e) {
              this.fire('iron-signal', {name:'forwardtest-deleted'});
          },

          onDeleteForwardtestError: function(e) {

          },

      });
  </script>
</dom-module>
